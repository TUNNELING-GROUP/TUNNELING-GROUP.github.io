

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aquaduct.apps.valvecore &#8212; Aqua-Duct 0.5.14 documentation</title>
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../../_static/ficon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aqua-Duct 0.5.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../aquaduct.html" accesskey="U">aquaduct</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/AQUADUCT_LOGO.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for aquaduct.apps.valvecore</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># Aqua-Duct, a tool facilitating analysis of the flow of solvent molecules in molecular dynamic simulations</span>
<span class="c1"># Copyright (C) 2016-2018  Tomasz Magdziarz, Alicja Płuciennik, Michał Stolarczyk &lt;info@aquaduct.pl&gt;</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="c1">#import ipdb as pdb</span>


<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip_longest</span><span class="p">,</span> <span class="n">izip</span><span class="p">,</span> <span class="n">imap</span>
<span class="kn">from</span> <span class="nn">keyword</span> <span class="k">import</span> <span class="n">iskeyword</span>

<span class="kn">import</span> <span class="nn">array</span>

<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">ttest_ind</span>

<span class="kn">from</span> <span class="nn">aquaduct.utils.clui</span> <span class="k">import</span> <span class="n">roman</span>

<span class="kn">from</span> <span class="nn">aquaduct</span> <span class="k">import</span> <span class="n">greetings</span> <span class="k">as</span> <span class="n">greetings_aquaduct</span>
<span class="kn">from</span> <span class="nn">aquaduct</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">aquaduct</span> <span class="k">import</span> <span class="n">version_nice</span> <span class="k">as</span> <span class="n">aquaduct_version_nice</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.data</span> <span class="k">import</span> <span class="n">get_vda_reader</span><span class="p">,</span> <span class="n">GCS</span><span class="p">,</span> <span class="n">CRIC</span><span class="p">,</span> <span class="n">save_cric</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom</span> <span class="k">import</span> <span class="n">traces</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom.cluster</span> <span class="k">import</span> <span class="n">AVAILABLE_METHODS</span> <span class="k">as</span> <span class="n">available_clusterization_methods</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom.cluster</span> <span class="k">import</span> <span class="n">PerformClustering</span><span class="p">,</span> <span class="n">DBSCAN</span><span class="p">,</span> <span class="n">AffinityPropagation</span><span class="p">,</span> <span class="n">MeanShift</span><span class="p">,</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">Birch</span><span class="p">,</span> \
    <span class="n">BarberCluster</span><span class="p">,</span> <span class="n">get_required_params</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom.master</span> <span class="k">import</span> <span class="n">CTypeSpathsCollection</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom.smooth</span> <span class="k">import</span> <span class="n">WindowSmooth</span><span class="p">,</span> <span class="n">MaxStepSmooth</span><span class="p">,</span> <span class="n">WindowOverMaxStepSmooth</span><span class="p">,</span> <span class="n">ActiveWindowSmooth</span><span class="p">,</span> \
    <span class="n">ActiveWindowOverMaxStepSmooth</span><span class="p">,</span> <span class="n">DistanceWindowSmooth</span><span class="p">,</span> <span class="n">DistanceWindowOverMaxStepSmooth</span><span class="p">,</span> <span class="n">SavgolSmooth</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.barber</span> <span class="k">import</span> <span class="n">WhereToCut</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.dumps</span> <span class="k">import</span> <span class="n">TmpDumpWriterOfMDA</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.inlets</span> <span class="k">import</span> <span class="n">InletClusterGenericType</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.inlets</span> <span class="k">import</span> <span class="n">Inlets</span><span class="p">,</span> <span class="n">InletTypeCodes</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.paths</span> <span class="k">import</span> <span class="n">GenericPaths</span><span class="p">,</span> <span class="n">yield_single_paths</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">,</span> <span class="n">SinglePath</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.paths</span> <span class="k">import</span> <span class="n">union_full</span><span class="p">,</span> <span class="n">yield_generic_paths</span>
<span class="c1"># from aquaduct.traj.reader import ReadViaMDA</span>
<span class="c1"># from aquaduct.traj.selections import CompactSelectionMDA</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils</span> <span class="k">import</span> <span class="n">clui</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.helpers</span> <span class="k">import</span> <span class="n">range2int</span><span class="p">,</span> <span class="n">Auto</span><span class="p">,</span> <span class="n">what2what</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">is_number</span><span class="p">,</span> <span class="n">robust_and</span><span class="p">,</span> <span class="n">robust_or</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.multip</span> <span class="k">import</span> <span class="n">optimal_threads</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.sandwich</span> <span class="k">import</span> <span class="n">ResidueSelection</span><span class="p">,</span> <span class="n">Reader</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.helpers</span> <span class="k">import</span> <span class="n">SmartRange</span><span class="p">,</span> <span class="n">iterate_or_die</span>

<span class="n">__mail__</span> <span class="o">=</span> <span class="s1">&#39;info@aquaduct.pl&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">aquaduct_version_nice</span><span class="p">()</span>


<span class="c1">###############################################################################</span>
<span class="c1"># configuration file helpers</span>

<span class="k">class</span> <span class="nc">ConfigSpecialNames</span><span class="p">:</span>
    <span class="n">special_names_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;null&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="s1">&#39;false&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="s1">&#39;yes&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                          <span class="s1">&#39;no&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="s1">&#39;auto&#39;</span><span class="p">:</span> <span class="n">Auto</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">special_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_names_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_names_dict</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">name</span>


<span class="c1"># TODO: add parser for initial checking of configuration file</span>
<div class="viewcode-block" id="ValveConfig"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig">[docs]</a><span class="k">class</span> <span class="nc">ValveConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">ConfigSpecialNames</span><span class="p">):</span>
<div class="viewcode-block" id="ValveConfig.__init__"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_config</span><span class="p">()</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__make_options_nt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_options</span><span class="p">):</span>
        <span class="c1"># options = {opt: self.special_name(input_options[opt]) for opt in input_options}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">input_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iskeyword</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid keyword &lt;</span><span class="si">%s</span><span class="s1">&gt; in config file skipped. Check configuration file.&#39;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_name</span><span class="p">(</span><span class="n">input_options</span><span class="p">[</span><span class="n">opt</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyword &lt;</span><span class="si">%s</span><span class="s1">&gt; in config file skipped.&#39;</span> <span class="o">%</span> <span class="n">opt</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">options_nt</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Options&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">options_nt</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.common_config_names"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.common_config_names">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">common_config_names</span><span class="p">():</span>
        <span class="c1"># execute - what to do: skip, run</span>
        <span class="c1"># load - load previous results form file name</span>
        <span class="c1"># save - save results to file name</span></div>
        <span class="k">return</span> <span class="s1">&#39;execute dump&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<div class="viewcode-block" id="ValveConfig.common_traj_data_config_names"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.common_traj_data_config_names">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">common_traj_data_config_names</span><span class="p">():</span>
        <span class="c1"># scope - scope definition</span>
        <span class="c1"># scope_convexhull - take convex hull of scope, true of false</span>
        <span class="c1"># object - object definition</span></div>
        <span class="k">return</span> <span class="s1">&#39;scope scope_convexhull scope_everyframe object&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<div class="viewcode-block" id="ValveConfig.global_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.global_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">global_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;global&#39;</span>

<div class="viewcode-block" id="ValveConfig.cluster_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.cluster_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cluster_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;clusterization&#39;</span>

<div class="viewcode-block" id="ValveConfig.recluster_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.recluster_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">recluster_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;reclusterization&#39;</span>

<div class="viewcode-block" id="ValveConfig.recursive_clusterization_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.recursive_clusterization_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">recursive_clusterization_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;recursive_clusterization&#39;</span>

<div class="viewcode-block" id="ValveConfig.recursive_threshold_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.recursive_threshold_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">recursive_threshold_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;recursive_threshold&#39;</span>

<div class="viewcode-block" id="ValveConfig.smooth_name"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.smooth_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">smooth_name</span><span class="p">():</span></div>
        <span class="k">return</span> <span class="s1">&#39;smooth&#39;</span>

<div class="viewcode-block" id="ValveConfig.stage_names"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.stage_names">[docs]</a>    <span class="k">def</span> <span class="nf">stage_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;traceable_residues&#39;</span>
            <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;raw_paths&#39;</span>
            <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;separate_paths&#39;</span>
            <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;inlets_clusterization&#39;</span>
            <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;analysis&#39;</span>
            <span class="k">elif</span> <span class="n">nr</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;visualize&#39;</span></div>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Stage </span><span class="si">%r</span><span class="s1"> is not implemented.&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_common_traj_data"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_common_traj_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_common_traj_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="c1"># options = {name: None for name in self.common_traj_data_config_names()}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_traj_data_config_names</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_traj_data_config_names</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_options_nt</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_global_options"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_global_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_global_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span><span class="p">()</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="c1"># options = {name: self.config.get(section, name) for name in names}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">))</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_options_nt</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_stage_options"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_stage_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_stage_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">stage_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
        <span class="c1"># options = {name: self.config.get(stage_name, name) for name in names}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_common_traj_data</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span><span class="o">.</span><span class="n">_asdict</span><span class="p">())</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_options_nt</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_cluster_options"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_cluster_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_cluster_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">section_name</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="c1"># options = {name: self.config.get(section, name) for name in names}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">))</span>
        <span class="c1"># special recursive_clusterization option</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_clusterization_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive_clusterization_name</span><span class="p">():</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_threshold_name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive_threshold_name</span><span class="p">():</span> <span class="kc">None</span><span class="p">})</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_options_nt</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_recluster_options"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_recluster_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_recluster_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_options</span><span class="p">(</span><span class="n">section_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recluster_name</span><span class="p">())</span>

<div class="viewcode-block" id="ValveConfig.get_smooth_options"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_smooth_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_smooth_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_name</span><span class="p">()</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="c1"># options = {name: self.config.get(section, name) for name in names}</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">))</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_options_nt</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_default_config"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_default_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># snr = 0 # stage number</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">common</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_config_names</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s1">&#39;execute&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;runonce&#39;</span>
                <span class="k">elif</span> <span class="n">setting</span> <span class="o">==</span> <span class="s1">&#39;dump&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_data.dump&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">common_traj_data</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">commented</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_traj_data_config_names</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">commented</span><span class="p">:</span>
                    <span class="n">setting</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">setting</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="c1"># global settings</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="c1"># top - top file name</span>
        <span class="c1"># nc - netcdf file name</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span>  <span class="c1"># topology</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;trj&#39;</span><span class="p">)</span>  <span class="c1"># trajectory</span>

        <span class="c1"># config.set(section, &#39;pbar&#39;, &#39;simple&#39;)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># stage number</span>
        <span class="c1"># stage I</span>
        <span class="c1"># find traceable residues</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">common_traj_data</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;scope_everyframe&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># stage II</span>
        <span class="c1"># find raw paths</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">common_traj_data</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;clear_in_object_info&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># stage III</span>
        <span class="c1"># create separate frames</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;allow_passing_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber_tovdw&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber_maxcut&#39;</span><span class="p">,</span> <span class="s1">&#39;2.8&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber_mincut&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber_maxcut_level&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber_mincut_level&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;auto_barber&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;discard_empty_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;sort_by_id&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;apply_smoothing&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;apply_soft_smoothing&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;discard_short_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;discard_short_object&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;discard_short_logic&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># stage IV</span>
        <span class="c1"># inlets clusterisation</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;max_level&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;recluster_outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;detect_outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;singletons_outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;create_master_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;exclude_passing_in_clusterization&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;add_passing_to_clusters&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="c1"># smooth</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_name</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="c1"># clusterization</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;barber&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_clusterization_name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_threshold_name</span><span class="p">(),</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="c1"># reclusterization</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recluster_name</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_clusterization_name</span><span class="p">(),</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_threshold_name</span><span class="p">(),</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># stage V</span>
        <span class="c1"># analysis</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;dump&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_results.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;calculate_scope_object_size&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;scope_chull&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;object_chull&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;dump_config&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>

        <span class="c1">################</span>
        <span class="n">snr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># stage VI</span>
        <span class="c1"># visualize</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">common</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;dump&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_results.py&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;simply_smooths&#39;</span><span class="p">,</span> <span class="s1">&#39;RecursiveVector&#39;</span><span class="p">)</span>
        <span class="c1"># visualize spaths, all paths in one object</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;all_paths_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;all_paths_smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;all_paths_split&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>  <span class="c1"># split by in obj out</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;all_paths_raw_io&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;all_paths_smooth_io&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1"># visualize spaths, separate objects</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;paths_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;paths_smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;paths_states&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;paths_raw_io&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;paths_smooth_io&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;ctypes_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;ctypes_smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1"># visualize clusters</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;inlets_clusters&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="c1"># show protein</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_molecule&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_molecule_frames&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_scope_chull&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_scope_chull_frames&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_object_chull&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;show_object_chull_frames&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</div>
        <span class="k">return</span> <span class="n">config</span>

<div class="viewcode-block" id="ValveConfig.load_config"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_filename</span> <span class="o">=</span> <span class="n">filename</span>

<div class="viewcode-block" id="ValveConfig.save_config_stream"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.save_config_stream">[docs]</a>    <span class="k">def</span> <span class="nf">save_config_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.save_config"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config_stream</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

<div class="viewcode-block" id="ValveConfig.get_general_comment"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.get_general_comment">[docs]</a>    <span class="k">def</span> <span class="nf">get_general_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_name</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Global settings.&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">():</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Possible clusterization methods:&#39;</span><span class="p">]</span>
            <span class="c1"># get default clusterization method</span>
            <span class="n">defmet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">available_clusterization_methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">defmet</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;method = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">get_required_params</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">sss</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">sss</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Required parameter</span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> method:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sss</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = None&#39;</span> <span class="o">%</span> <span class="n">param</span><span class="p">)</span>
                    <span class="c1"># out.append(&#39;&#39;)</span></div>
            <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="ValveConfig.dump_config"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.ValveConfig.dump_config">[docs]</a>    <span class="k">def</span> <span class="nf">dump_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dump_template</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">skip_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;simply_smooths&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># these options are very optional!</span>
        <span class="n">concise</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">dump_template</span><span class="p">:</span>
            <span class="n">concise</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_global_options</span><span class="p">()]</span> <span class="o">+</span> \
                  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="o">+</span> \
                  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_options</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recluster_options</span><span class="p">(),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">global_name</span><span class="p">()]</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span> <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="o">+</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">recluster_name</span><span class="p">(),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">smooth_name</span><span class="p">()]</span>

        <span class="k">def</span> <span class="nf">value2str</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">Auto</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot;Auto&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>

        <span class="c1"># this loop ensures it is returned in particular order</span>
        <span class="k">for</span> <span class="n">opts</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># section name</span>
            <span class="c1"># general comments</span>
            <span class="k">if</span> <span class="n">dump_template</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_general_comment</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;# </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">comment</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>  <span class="c1"># loop over options</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">skip_list</span><span class="p">:</span> <span class="k">continue</span>
                <span class="c1"># comment scope etc. in stage II if dump_template</span>
                <span class="k">if</span> <span class="n">dump_template</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_traj_data_config_names</span><span class="p">():</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">key</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value2str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">concise</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># is something missing? another loop over all additional sections</span>
        <span class="k">for</span> <span class="n">miss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">miss</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># skip if it was already dumped in the loop above</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">miss</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">miss</span><span class="p">):</span>  <span class="c1"># loop over options in section miss</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">skip_list</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">miss</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value2str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">concise</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div></div>
        <span class="k">return</span> <span class="n">output</span>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">get_res_in_scope</span><span class="p">(</span><span class="n">is_res_in_scope</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
    <span class="n">res_new</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">iris</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">is_res_in_scope</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">iterate_over_residues</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">iris</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res_new</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_new</span> <span class="o">+=</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">res_new</span>


<span class="c1">################################################################################</span>
<span class="c1"># separators - logging</span>

<span class="k">def</span> <span class="nf">sep</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">clui</span><span class="o">.</span><span class="n">gsep</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">asep</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">clui</span><span class="o">.</span><span class="n">gsep</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="mi">72</span><span class="p">)</span>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">get_smooth_method</span><span class="p">(</span><span class="n">soptions</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;mss&#39;</span><span class="p">,</span> <span class="s1">&#39;window_mss&#39;</span><span class="p">,</span> <span class="s1">&#39;awin&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;awin_mss&#39;</span><span class="p">,</span> <span class="s1">&#39;dwin&#39;</span><span class="p">,</span> <span class="s1">&#39;dwin_mss&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;savgol&#39;</span><span class="p">],</span> <span class="s1">&#39;Unknown smoothing method </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;recursive&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;recursive&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">recursive</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">window_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;window&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">window</span><span class="p">))})</span>
        <span class="n">function_opts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">awin_dwin_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;window&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">window</span><span class="p">)})</span>
        <span class="n">function_opts</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">function_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;function&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">soptions</span><span class="o">.</span><span class="n">function</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">],</span> <span class="s1">&#39;Unknown smoothing function </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">soptions</span><span class="o">.</span><span class="n">function</span>
            <span class="k">if</span> <span class="n">soptions</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">soptions</span><span class="o">.</span><span class="n">function</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">mss_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">step</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">savgol_opts</span><span class="p">():</span>
        <span class="n">window_length</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># TODO: magic constant (default value)</span>
        <span class="k">if</span> <span class="s1">&#39;window&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">window</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">window_length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Window in Savgol method must be positive odd number, </span><span class="si">%d</span><span class="s1"> given instead.&#39;</span> <span class="o">%</span> <span class="n">window_length</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;window_length&#39;</span><span class="p">:</span> <span class="n">window_length</span><span class="p">})</span>
        <span class="n">polyorder</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># TODO: magic constant (default value)</span>
        <span class="k">if</span> <span class="s1">&#39;polyorder&#39;</span> <span class="ow">in</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">polyorder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">soptions</span><span class="o">.</span><span class="n">polyorder</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">polyorder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Polynomial order should be greater then 0, </span><span class="si">%d</span><span class="s1"> given instead.&#39;</span> <span class="o">%</span> <span class="n">polyorder</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;polyorder&#39;</span><span class="p">:</span> <span class="n">polyorder</span><span class="p">})</span>
        <span class="k">assert</span> <span class="n">polyorder</span> <span class="o">&lt;</span> <span class="n">window_length</span><span class="p">,</span> <span class="s1">&#39;Polynomial order (</span><span class="si">%d</span><span class="s1">) should be less then window (</span><span class="si">%d</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">polyorder</span><span class="p">,</span> <span class="n">window_length</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if &#39;deriv&#39; in soptions._asdict():</span>
<span class="sd">            deriv = int(float(soptions.deriv))</span>
<span class="sd">            assert deriv &gt;= 0 and deriv &lt;= polyorder, &#39;Order of derrivative should be integer greater or equal 0 and less then or equal to Polynomial order (%d), %d given instead.&#39; % (polyorder,deriv)</span>
<span class="sd">            opts.update({&#39;deriv&#39;: deriv})</span>
<span class="sd">        if &#39;delta&#39; in soptions._asdict():</span>
<span class="sd">            delta = float(soptions.delta)</span>
<span class="sd">            assert delta &gt;= 0, &#39;Delta should be greater or equal 0, %f given instead.&#39; % delta</span>
<span class="sd">            if &#39;deriv&#39; in soptions._asdict():</span>
<span class="sd">                if deriv == 0:</span>
<span class="sd">                    logger.warning(&#39;Delta %f make no sense if deriv is 0.&#39; % delta)</span>
<span class="sd">            opts.update({&#39;delta&#39;: delta})</span>
<span class="sd">        mode = &#39;interp&#39; # TODO: magic constant (default value)</span>
<span class="sd">        if &#39;mode&#39; in soptions._asdict():</span>
<span class="sd">            mode = str(soptions.mode)</span>
<span class="sd">            assert mode in [&#39;mirror&#39;, &#39;constant&#39;, &#39;nearest&#39;, &#39;wrap&#39;, &#39;interp&#39;], &#39;Unknown mode %s.&#39; % mode</span>
<span class="sd">            opts.update({&#39;mode&#39;: mode})</span>
<span class="sd">        if &#39;cval&#39; in soptions._asdict():</span>
<span class="sd">            cval = float(soptions.cval)</span>
<span class="sd">            if mode != &#39;constant&#39;:</span>
<span class="sd">                logger.warning(&#39;Cval make no sense if mode is %s.&#39; % mode)</span>
<span class="sd">            opts.update({&#39;cval&#39;: cval})</span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;window&#39;</span><span class="p">:</span>
        <span class="n">window_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">WindowSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;awin&#39;</span><span class="p">:</span>
        <span class="n">awin_dwin_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">ActiveWindowSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;dwin&#39;</span><span class="p">:</span>
        <span class="n">awin_dwin_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">DistanceWindowSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mss&#39;</span><span class="p">:</span>
        <span class="n">mss_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">MaxStepSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;window_mss&#39;</span><span class="p">:</span>
        <span class="n">window_opts</span><span class="p">()</span>
        <span class="n">mss_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">WindowOverMaxStepSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;awin_mss&#39;</span><span class="p">:</span>
        <span class="n">awin_dwin_opts</span><span class="p">()</span>
        <span class="n">mss_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">ActiveWindowOverMaxStepSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;dwin_mss&#39;</span><span class="p">:</span>
        <span class="n">awin_dwin_opts</span><span class="p">()</span>
        <span class="n">mss_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">DistanceWindowOverMaxStepSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">soptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;savgol&#39;</span><span class="p">:</span>
        <span class="n">savgol_opts</span><span class="p">()</span>
        <span class="n">smooth</span> <span class="o">=</span> <span class="n">SavgolSmooth</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">smooth</span>


<span class="k">def</span> <span class="nf">get_auto_barber_options</span><span class="p">(</span><span class="n">abo</span><span class="p">):</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber_maxcut&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_maxcut</span><span class="p">):</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;maxcut&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_maxcut</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;maxcut&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber_mincut&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_mincut</span><span class="p">):</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mincut&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_mincut</span><span class="p">)})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mincut&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber_mincut_level&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;mincut_level&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_mincut_level</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber_maxcut_level&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;maxcut_level&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_maxcut_level</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;auto_barber_tovdw&#39;</span> <span class="ow">in</span> <span class="n">abo</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;tovdw&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">abo</span><span class="o">.</span><span class="n">auto_barber_tovdw</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">opts</span>


<span class="k">def</span> <span class="nf">get_clustering_method</span><span class="p">(</span><span class="n">coptions</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">available_clusterization_methods</span><span class="p">,</span> <span class="s1">&#39;Unknown clusterization method </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">dbscan_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;eps&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;eps&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">eps</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;min_samples&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;min_samples&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">min_samples</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">coptions</span><span class="o">.</span><span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cityblock&#39;</span><span class="p">,</span> <span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;manhattan&#39;</span><span class="p">],</span> <span class="s2">&quot;Unknown metric &lt;</span><span class="si">%s</span><span class="s2">&gt;.&quot;</span> <span class="o">%</span> <span class="n">coptions</span><span class="o">.</span><span class="n">metric</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">metric</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;algorithm&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">coptions</span><span class="o">.</span><span class="n">algorithm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ball_tree&#39;</span><span class="p">,</span> <span class="s1">&#39;kd_tree&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;brute&#39;</span><span class="p">],</span> <span class="s2">&quot;Unknown NN algorithm &lt;</span><span class="si">%s</span><span class="s2">&gt;.&quot;</span> <span class="o">%</span> <span class="n">coptions</span><span class="o">.</span><span class="n">algorithm</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;leaf_size&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;leaf_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">leaf_size</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">affprop_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;damping&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;damping&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">damping</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;convergence_iter&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;convergence_iter&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">convergence_iter</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;max_iter&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;preference&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;preference&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">preference</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">kmeans_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;n_clusters&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;max_iter&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;n_init&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;n_init&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">n_init</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;init&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">coptions</span><span class="o">.</span><span class="n">init</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k-means++&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">],</span> <span class="s2">&quot;Unknown initialization method &lt;</span><span class="si">%s</span><span class="s2">&gt;.&quot;</span> <span class="o">%</span> <span class="n">coptions</span><span class="o">.</span><span class="n">init</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">init</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;tol&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;tol&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">tol</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">meanshift_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;cluster_all&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;cluster_all&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">cluster_all</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;bandwidth&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">coptions</span><span class="o">.</span><span class="n">bandwidth</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Auto</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="n">coptions</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;bin_seeding&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;bin_seeding&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">bin_seeding</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;min_bin_freq&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;min_bin_freq&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">min_bin_freq</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">birch_opts</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">threshold</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;branching_factor&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;branching_factor&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">branching_factor</span><span class="p">)})</span>
        <span class="k">if</span> <span class="s1">&#39;n_clusters&#39;</span> <span class="ow">in</span> <span class="n">coptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">():</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">coptions</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">barber_opts</span><span class="p">():</span>
        <span class="n">abo</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">abo</span><span class="p">))</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">coptions</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;dbscan&#39;</span><span class="p">:</span>
        <span class="n">dbscan_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">DBSCAN</span>
    <span class="k">elif</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;affprop&#39;</span><span class="p">:</span>
        <span class="n">affprop_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">AffinityPropagation</span>
    <span class="k">elif</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;kmeans&#39;</span><span class="p">:</span>
        <span class="n">kmeans_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">KMeans</span>
    <span class="k">elif</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;meanshift&#39;</span><span class="p">:</span>
        <span class="n">meanshift_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">MeanShift</span>
    <span class="k">elif</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;birch&#39;</span><span class="p">:</span>
        <span class="n">birch_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">Birch</span>
    <span class="k">elif</span> <span class="n">coptions</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;barber&#39;</span><span class="p">:</span>
        <span class="n">barber_opts</span><span class="p">()</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">BarberCluster</span>

    <span class="k">return</span> <span class="n">PerformClustering</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_linearize_method</span><span class="p">(</span><span class="n">loption</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">loption</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loption</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)),</span> <span class="s2">&quot;Wrong Linearize method definition: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">loption</span>
        <span class="n">possible_formats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(recursive|oneway|hobbit)(triangle|vector)[(][+-]?(\d+(\.\d*)?|\.\d+)([eE][+-]?\d+)?[)]$&#39;</span><span class="p">),</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(recursive|oneway|hobbit)(triangle|vector)[(][)]$&#39;</span><span class="p">),</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(recursive|oneway|hobbit)(triangle|vector)$&#39;</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="kc">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pf</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">loption</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span>
                        <span class="n">possible_formats</span><span class="p">],</span> <span class="s2">&quot;Wrong Linearize method definition: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">loption</span>
        <span class="c1"># http://stackoverflow.com/questions/12929308/python-regular-expression-that-matches-floating-point-numbers#12929311</span>
        <span class="n">way</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="s1">&#39;oneway&#39;</span><span class="p">,</span> <span class="s1">&#39;hobbit&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">loption</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">crit</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;triangle&#39;</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">loption</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[+-]?(\d+(\.\d*)?|\.\d+)([eE][+-]?\d+)?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">loption</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># get method</span>
        <span class="k">if</span> <span class="n">way</span> <span class="o">==</span> <span class="s1">&#39;recursive&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">crit</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeRecursiveTriangle</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeRecursiveVector</span>
        <span class="k">elif</span> <span class="n">way</span> <span class="o">==</span> <span class="s1">&#39;oneway&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">crit</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeOneWayTriangle</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeOneWayVector</span>
        <span class="k">elif</span> <span class="n">way</span> <span class="o">==</span> <span class="s1">&#39;hobbit&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">crit</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeHobbitTriangle</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">met</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">LinearizeHobbitVector</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">met</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">met</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>


<span class="c1">################################################################################</span>

<div class="viewcode-block" id="valve_begin"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.valve_begin">[docs]</a><span class="k">def</span> <span class="nf">valve_begin</span><span class="p">():</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">greetings_aquaduct</span><span class="p">())</span>  <span class="c1"># nice greetings</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Aqua-Duct version </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">aquaduct_version_nice</span><span class="p">())</span>
    <span class="c1"># clui.message(&#39;Valve driver version %s&#39; % version_nice())</span></div>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>


<div class="viewcode-block" id="valve_end"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.valve_end">[docs]</a><span class="k">def</span> <span class="nf">valve_end</span><span class="p">():</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Let the Valve be always open!&#39;</span><span class="p">)</span></div>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Goodbye!&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="valve_load_config"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.valve_load_config">[docs]</a><span class="k">def</span> <span class="nf">valve_load_config</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No config file provided.&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;Config file </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Load configuration file&#39;</span><span class="p">):</span></div>
        <span class="n">config</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def valve_read_trajectory(top, traj, frames_window=None):</span>
<span class="sd">    with clui.fbm(&#39;Read trajectory&#39;):</span>
<span class="sd">        return TrajectoryReader(top, traj, frames_window=frames_window)</span>
<span class="sd">        # read trajectory</span>
<span class="sd">        # traj_list = shlex.split(traj)</span>
<span class="sd">        # return ReadAmberNetCDFviaMDA(top, traj_list)</span>
<span class="sd">        # reader = ReadDCDviaMDA(topology, trajectory)</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="k">def</span> <span class="nf">valve_begin_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Starting Stage </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roman</span><span class="o">.</span><span class="n">toRoman</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">)))</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Execute mode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span>


<div class="viewcode-block" id="valve_exec_stage"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.valve_exec_stage">[docs]</a><span class="k">def</span> <span class="nf">valve_exec_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">stage_run</span><span class="p">,</span> <span class="n">no_io</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">tictoc</span><span class="p">(</span><span class="s1">&#39;Stage </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roman</span><span class="o">.</span><span class="n">toRoman</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">))):</span>

        <span class="c1"># This function runs stages in a smart way, checks execution logic, and loads/saves dumps if required.</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">valve_begin_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">run_status</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">stage</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># TODO: Consider to create traj_reader object here instead of doing it in stage_run or in load...</span>
        <span class="c1"># execute?</span>
        <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_io</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># has to be run?</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">can_be_loaded</span> <span class="ow">and</span> <span class="n">stage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run_status</span><span class="p">[</span><span class="n">stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">can_be_loaded</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stage_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">save_cric</span><span class="p">()</span>
            <span class="n">run_status</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">stage</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
                <span class="c1">###########</span>
                <span class="c1"># S A V E #</span>
                <span class="c1">###########</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Saving data dump in </span><span class="si">%s</span><span class="s1"> file&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                    <span class="n">vda</span> <span class="o">=</span> <span class="n">get_vda_reader</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span>
                    <span class="n">vda</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">data_file_name</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
                <span class="c1"># save_stage_dump(options.dump, **result)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">can_be_loaded</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
                <span class="c1">###########</span>
                <span class="c1"># L O A D #</span>
                <span class="c1">###########</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Loading data dump from </span><span class="si">%s</span><span class="s1"> file&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                        <span class="n">vda</span> <span class="o">=</span> <span class="n">get_vda_reader</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">vda</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">data_file_name</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="c1"># result = load_stage_dump(options.dump, reader=reader)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;exec mode </span><span class="si">%s</span><span class="s1"> not implemented&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span><span class="p">)</span>
        <span class="c1"># remove options stuff</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></div>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;options&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">))</span>


<span class="c1">################################################################################</span>
<span class="c1"># stages run</span>

<span class="c1"># traceable_residues</span>
<div class="viewcode-block" id="stage_I_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_I_run">[docs]</a><span class="k">def</span> <span class="nf">stage_I_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># create pool of workers - mapping function</span>
    <span class="n">map_fun</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="k">if</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
        <span class="n">map_fun</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Loop over frames - search of residues in object:&quot;</span><span class="p">)</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">())</span>

    <span class="c1"># create some containers</span>
    <span class="n">number_frame_rid_in_object</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># res_ids_in_scope_over_frames = {}  # not used</span>
    <span class="n">all_res</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># scope will be used to derrive center of system</span>
    <span class="n">center_of_system</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

    <span class="c1"># loop over possible layers of sandwich</span>
    <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="c1"># scope is evaluated only once before the loop over frames starts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>

        <span class="c1"># all_res_this_layer = [] # list of all new res in this layer found in an order of apparance</span>

        <span class="n">frame_rid_in_object</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># the loop over frames</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">iterate_over_frames</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
            <span class="c1"># center of system</span>
            <span class="n">center_of_system</span> <span class="o">+=</span> <span class="n">scope</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">()</span>
            <span class="c1"># current res selection</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span>
            <span class="c1"># find matching residues, ie those which are in the scope:</span>
            <span class="n">res_new</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">containing_residues</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">convex_hull</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">,</span> <span class="n">map_fun</span><span class="o">=</span><span class="n">map_fun</span><span class="p">)</span>
            <span class="n">res_new</span><span class="o">.</span><span class="n">uniquify</span><span class="p">()</span>  <span class="c1"># here is a list of residues in this layer that are in the object and in the scope</span>
            <span class="c1"># adds them to all_res</span>
            <span class="k">if</span> <span class="n">all_res</span><span class="p">:</span>
                <span class="n">all_res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">res_new</span><span class="p">)</span>
                <span class="n">all_res</span><span class="o">.</span><span class="n">uniquify</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_res</span> <span class="o">=</span> <span class="n">res_new</span>
            <span class="c1"># remeber ids of res in object in current frame</span>
            <span class="k">if</span> <span class="n">res_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">res_new</span><span class="o">.</span><span class="n">ids</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="n">number_frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_rid_in_object</span><span class="p">)</span>

    <span class="c1"># destroy pool of workers</span>
    <span class="k">if</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">pool</span>

    <span class="c1"># res_ids_in_object_frames_list = [res_ids_in_object_frames_list[number][rid] for number,rid in all_res.ids()]</span>

    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">center_of_system</span> <span class="o">/=</span> <span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Center of system is </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">center_of_system</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">all_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No traceable residues was found.&quot;</span><span class="p">)</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of residues to trace: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">all_res</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>

    <span class="c1"># &#39;res_ids_in_object_over_frames&#39;: IdsOverIds.dict2arrays(res_ids_in_object_over_frames),</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;all_res&#39;</span><span class="p">:</span> <span class="n">all_res</span><span class="p">,</span>
            <span class="c1"># &#39;res_ids_in_object_over_frames&#39;: res_ids_in_object_over_frames,</span>
            <span class="s1">&#39;number_frame_rid_in_object&#39;</span><span class="p">:</span> <span class="n">number_frame_rid_in_object</span><span class="p">,</span>
            <span class="s1">&#39;center_of_system&#39;</span><span class="p">:</span> <span class="n">center_of_system</span><span class="p">,</span></div>
            <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()}</span>


<span class="c1">################################################################################</span>

<span class="c1"># raw_paths</span>
<div class="viewcode-block" id="stage_II_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_II_run">[docs]</a><span class="k">def</span> <span class="nf">stage_II_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">all_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">number_frame_rid_in_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># res_ids_in_object_over_frames=None,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">####################################################################################################################</span>
    <span class="c1"># FIXME: temporary solution, remove it later</span>
    <span class="k">if</span> <span class="s1">&#39;res_ids_in_object_over_frames&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">res_ids_in_object_over_frames</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;res_ids_in_object_over_frames&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_ids_in_object_over_frames</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">number_frame_rid_in_object</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">res_ids_in_object_over_frames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Get number_frame_rid_in_object if possible&quot;</span><span class="p">):</span>
            <span class="n">number_frame_rid_in_object</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">res_ids_in_object_over_frames</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">frame_rid_in_object</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">res_ids_in_object_over_frames</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                    <span class="n">frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_ids_in_object_over_frames</span><span class="p">[</span><span class="n">number</span><span class="p">][</span><span class="n">layer</span><span class="p">])</span>
                <span class="n">number_frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame_rid_in_object</span><span class="p">)</span>
    <span class="c1">####################################################################################################################</span>
    <span class="c1"># create pool of workers - mapping function</span>
    <span class="n">map_fun</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="k">if</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">all_res</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">/</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">**</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Chunk size </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="n">map_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="c1">#map_fun = pool.map</span>
    <span class="c1"># clear in object info if required</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">clear_in_object_info</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Clear data on residues in object over frames.&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;This will be recalculated on demand.&#39;</span><span class="p">)</span>
        <span class="n">number_frame_rid_in_object</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">is_number_frame_rid_in_object</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    with clui.fbm(&quot;Init paths container&quot;):</span>
<span class="sd">        number_of_frames = Reader.window.len() - 1</span>
<span class="sd">        paths = dict(</span>
<span class="sd">            ((resid, GenericPaths(resid, name_of_res=resname, single_res_selection=sressel,</span>
<span class="sd">                                  min_pf=0, max_pf=number_of_frames))</span>
<span class="sd">             for resid, resname, sressel in</span>
<span class="sd">             zip(all_res.ids(), all_res.names(), all_res.single_residues())))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">number_of_frames</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Trajectory scan:&quot;</span><span class="p">)</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">())</span>
    <span class="c1"># loop over possible layers of sandwich</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frame_rid_in_object</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">)</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span>
            <span class="n">iterate_or_die</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()),</span> <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>

        <span class="c1"># scope is evaluated only once before loop over frames so it cannot be frame dependent</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scope definition evaluated only once for given layer&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scope definition evaluated in every frame, this might be very slow.&quot;</span><span class="p">)</span>

        <span class="c1"># speed up!</span>
        <span class="n">all_res_this_layer</span> <span class="o">=</span> <span class="n">all_res</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">all_res_this_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_res_this_layer</span><span class="o">.</span><span class="n">ids</span><span class="p">())</span>

        <span class="n">paths_this_layer</span> <span class="o">=</span> <span class="p">(</span><span class="n">GenericPaths</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span>
                                         <span class="n">name_of_res</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                                         <span class="n">single_res_selection</span><span class="o">=</span><span class="n">sressel</span><span class="p">,</span>
                                         <span class="n">min_pf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_pf</span><span class="o">=</span><span class="n">number_of_frames</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">resid</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">sressel</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">all_res_this_ids</span><span class="p">,</span>
                                                                <span class="n">all_res_this_layer</span><span class="o">.</span><span class="n">names</span><span class="p">(),</span>
                                                                <span class="n">all_res_this_layer</span><span class="o">.</span><span class="n">single_residues</span><span class="p">()))</span>

        <span class="c1"># big container for 012 path data</span>
        <span class="n">number_frame_object_scope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">all_res_this_layer</span><span class="o">.</span><span class="n">len</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="c1"># the loop over frames, use izip otherwise iteration over frames does not work</span>
        <span class="k">for</span> <span class="n">rid_in_object</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span>
                <span class="n">iterate_or_die</span><span class="p">(</span><span class="n">frame_rid_in_object</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="n">traj_reader</span><span class="o">.</span><span class="n">iterate_over_frames</span><span class="p">()):</span>

            <span class="c1"># do we have object data?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_number_frame_rid_in_object</span><span class="p">:</span>
                <span class="n">rid_in_object</span> <span class="o">=</span> <span class="p">[</span><span class="n">rid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span><span class="o">.</span><span class="n">ids</span><span class="p">()]</span>
            <span class="c1"># assert rid_in_object is not None</span>

            <span class="n">is_res_in_object</span> <span class="o">=</span> <span class="p">(</span><span class="n">rid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rid_in_object</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">all_res_this_ids</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
            <span class="c1"># check if all_res are in the scope, reuse res_ids_in_object_over_frames</span>
            <span class="n">is_res_in_scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">contains_residues</span><span class="p">(</span><span class="n">all_res_this_layer</span><span class="p">,</span> <span class="n">convex_hull</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">,</span>
                                                      <span class="n">map_fun</span><span class="o">=</span><span class="n">map_fun</span><span class="p">,</span>
                                                      <span class="n">known_true</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># known_true could be rid_in_object</span>

            <span class="n">number_frame_object_scope</span><span class="p">[</span><span class="n">frame</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">izip</span><span class="p">(</span><span class="n">is_res_in_object</span><span class="p">,</span><span class="n">is_res_in_scope</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="c1">#number_frame_object_scope = np.array(number_frame_object_scope,dtype=np.int8).T</span>
        <span class="c1"># another loop over this columns</span>
        <span class="k">for</span> <span class="n">pat</span><span class="p">,</span><span class="n">nfos</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">paths_this_layer</span><span class="p">,</span><span class="n">number_frame_object_scope</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="n">pat</span><span class="o">.</span><span class="n">add_012</span><span class="p">(</span><span class="n">nfos</span><span class="p">)</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">number_frame_object_scope</span>

        <span class="c1">#paths.extend(paths_this_layer)</span>

    <span class="c1"># destroy pool of workers</span>
    <span class="k">if</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">pool</span>

    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of paths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;all_res&#39;</span><span class="p">:</span> <span class="n">all_res</span><span class="p">,</span> <span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()}</span>


<span class="c1">################################################################################</span>

<span class="k">class</span> <span class="nc">ABSphere</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ABSphere&#39;</span><span class="p">,</span> <span class="s1">&#39;center radius&#39;</span><span class="p">)):</span>
    <span class="k">pass</span>


<span class="c1"># separate_paths</span>
<div class="viewcode-block" id="stage_III_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_III_run">[docs]</a><span class="k">def</span> <span class="nf">stage_III_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                  <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">allow_passing_paths</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Passing paths is a highly experimental feature. Please, analyze results with care.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_empty_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Discard residues with empty paths&quot;</span><span class="p">):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Create separate paths:&quot;</span><span class="p">)</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
    <span class="c1"># yield_single_paths requires a list of paths not a dictionary</span>
    <span class="n">spaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">yield_single_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span>
                                                  <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">passing</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">allow_passing_paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="si">%d</span><span class="s2"> separate paths out of </span><span class="si">%d</span><span class="s2"> raw paths&quot;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span><span class="s2">&quot;Removing unused parts of paths:&quot;</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">yield_generic_paths</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span><span class="n">progress</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span><span class="p">):</span>
            <span class="n">short_paths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">):</span>
            <span class="n">short_object</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_object</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">short_logic</span> <span class="o">=</span> <span class="n">robust_or</span>  <span class="c1"># for and use or, this is intentional</span>
            <span class="n">short_logic_name</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_logic</span> <span class="o">=</span> <span class="n">robust_and</span>
            <span class="n">short_logic_name</span> <span class="o">=</span> <span class="s2">&quot;OR&quot;</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span> <span class="o">!=</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid discard_short_logic &#39;</span><span class="si">%s</span><span class="s2">&#39;, using </span><span class="si">%s</span><span class="s2"> by default.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span><span class="p">,</span> <span class="n">short_logic_name</span><span class="p">))</span>
        <span class="c1"># make message</span>
        <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths shorter than </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> object shorter than </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">short_paths</span><span class="p">,</span> <span class="n">short_logic_name</span><span class="p">,</span> <span class="n">short_object</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths object shorter than </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">short_object</span>
        <span class="k">elif</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths shorter than </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">short_paths</span>
        <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="n">discard_message</span><span class="p">):</span>
                <span class="n">spaths_nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                <span class="c1"># TODO: if not short object is used there is no sense in calling object_len as it is very expensive</span>
                <span class="k">if</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">short_logic</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">short_paths</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">object_len</span> <span class="o">&gt;</span> <span class="n">short_object</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">short_paths</span><span class="p">]</span>
                <span class="n">spaths_nr_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spaths_nr</span> <span class="o">==</span> <span class="n">spaths_nr_new</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> paths were discarded.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spaths_nr</span> <span class="o">-</span> <span class="n">spaths_nr_new</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded - no values were set.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">:</span>
        <span class="n">wtc</span> <span class="o">=</span> <span class="n">WhereToCut</span><span class="p">(</span><span class="n">spaths</span><span class="o">=</span><span class="n">spaths</span><span class="p">,</span>
                         <span class="n">selection</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">,</span>
                         <span class="n">mincut</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_mincut</span><span class="p">,</span>
                         <span class="n">mincut_level</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_mincut_level</span><span class="p">,</span>
                         <span class="n">maxcut</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_maxcut</span><span class="p">,</span>
                         <span class="n">maxcut_level</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_maxcut_level</span><span class="p">,</span>
                         <span class="n">tovdw</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_tovdw</span><span class="p">)</span>
        <span class="c1"># cut thyself!</span>
        <span class="n">wtc</span><span class="o">.</span><span class="n">cut_thyself</span><span class="p">()</span>

        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Auto Barber in action:&quot;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">barber_with_spheres</span><span class="p">(</span><span class="n">wtc</span><span class="o">.</span><span class="n">spheres</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="c1"># now, it might be that some of paths are empty</span>
        <span class="c1"># paths = {k: v for k, v in paths.iteritems() if len(v.coords) &gt; 0}</span>
        <span class="c1"># paths = dict((k, v) for k, v in paths.iteritems() if</span>
        <span class="c1">#             len(v.frames) &gt; 0)  # more universal as dict comprehension may not work in &lt;2.7</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Recreate separate paths:&quot;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="c1"># yield_single_paths requires a list of paths not a dictionary</span>
        <span class="n">spaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">yield_single_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">passing</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">allow_passing_paths</span><span class="p">)</span> <span class="k">if</span>
                  <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="n">discard_message</span><span class="p">):</span>
                    <span class="n">spaths_nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                    <span class="n">spaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">short_logic</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">short_paths</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">object_len</span> <span class="o">&gt;</span> <span class="n">short_object</span><span class="p">)]</span>
                    <span class="n">spaths_nr_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spaths_nr</span> <span class="o">==</span> <span class="n">spaths_nr_new</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> paths were discarded.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spaths_nr</span> <span class="o">-</span> <span class="n">spaths_nr_new</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded - no values were set.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">sort_by_id</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Sort separate paths by resid&quot;</span><span class="p">):</span>
            <span class="n">spaths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">nr</span><span class="p">))</span>
    <span class="c1"># apply smoothing?</span>
    <span class="c1"># it is no longer necessary</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">apply_smoothing</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Hard smoothing is not available in the current version but may be available in the future. Stay tuned!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">apply_soft_smoothing</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Soft smoothing option is not available any more. Soft smoothing is enabled by default if --cache-dir or --cache-mem options are used.&quot;</span><span class="p">)</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of paths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of spaths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span> <span class="s1">&#39;spaths&#39;</span><span class="p">:</span> <span class="n">spaths</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span> <span class="s1">&#39;soptions&#39;</span><span class="p">:</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()}</span>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">get_allow_size_function</span><span class="p">(</span><span class="n">rt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^[&lt;&gt;=]+[0-9.]+$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Wrong threshold definition: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rt</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[&lt;&gt;=]+&#39;</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">vl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[0-9.]+&#39;</span><span class="p">)</span>
    <span class="n">vl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vl</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rt</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">operator_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
                     <span class="s1">&#39;=&gt;&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
                     <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
                     <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operator_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;Unsupported operator </span><span class="si">%s</span><span class="s2"> in threshold </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">rt</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">size_of_cluster</span><span class="p">:</span> <span class="n">operator_dict</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">size_of_cluster</span><span class="p">,</span> <span class="n">vl</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SkipSizeFunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ths_def</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ths_def</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">thd</span> <span class="ow">in</span> <span class="n">ths_def</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_allow_size_function</span><span class="p">(</span><span class="n">thd</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_of_cluster</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">thd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">thd</span><span class="p">(</span><span class="n">size_of_cluster</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">potentially_recursive_clusterization</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">clusterization_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">inlets_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">message</span><span class="o">=</span><span class="s1">&#39;clusterization&#39;</span><span class="p">,</span>
                                         <span class="n">deep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">max_level</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">%s</span><span class="s2">, level </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">deep</span><span class="p">,</span> <span class="n">max_level</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Clustering options section: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">clusterization_name</span><span class="p">)</span>
        <span class="n">cluster_options</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cluster_options</span><span class="p">(</span><span class="n">section_name</span><span class="o">=</span><span class="n">clusterization_name</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Clustering options:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="c1"># TODO: Print clusterization options in a nice way!</span>
        <span class="n">clustering_function</span> <span class="o">=</span> <span class="n">get_clustering_method</span><span class="p">(</span><span class="n">cluster_options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="c1"># special case of barber!!!</span>
        <span class="k">if</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;barber&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting inltets refs...&#39;</span><span class="p">)</span>
            <span class="n">inlets_refs</span> <span class="o">=</span> <span class="n">inlets_object</span><span class="o">.</span><span class="n">get_inlets_references</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting wtc...&#39;</span><span class="p">)</span>
            <span class="n">wtc</span> <span class="o">=</span> <span class="n">WhereToCut</span><span class="p">(</span><span class="n">spaths</span><span class="o">=</span><span class="p">(</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">inlets_refs</span><span class="p">),</span>
                             <span class="n">expected_nr_of_spaths</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">inlets_refs</span><span class="p">),</span>
                             <span class="n">forceempty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">clustering_function</span><span class="o">.</span><span class="n">method_kwargs</span><span class="p">)</span>
            <span class="c1"># clouds = wtc.cloud_groups(progress=True)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting spheres...&#39;</span><span class="p">)</span>
            <span class="n">inlets_object</span><span class="o">.</span><span class="n">add_spheres</span><span class="p">(</span><span class="n">wtc</span><span class="o">.</span><span class="n">spheres</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Proceed with clusterization, skip size...&#39;</span><span class="p">)</span>
        <span class="c1"># get skip_size function according to recursive_treshold</span>
        <span class="n">skip_size</span> <span class="o">=</span> <span class="n">SkipSizeFunction</span><span class="p">(</span><span class="n">cluster_options</span><span class="o">.</span><span class="n">recursive_threshold</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Proceed with clusterization, call method...&#39;</span><span class="p">)</span>
        <span class="n">inlets_object</span><span class="o">.</span><span class="n">perform_reclustering</span><span class="p">(</span><span class="n">clustering_function</span><span class="p">,</span> <span class="n">skip_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_size</span><span class="o">=</span><span class="n">skip_size</span><span class="p">)</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inlets_object</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cluster_options</span><span class="o">.</span><span class="n">recursive_clusterization</span><span class="p">:</span>
        <span class="n">deep</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">deep</span> <span class="o">&gt;</span> <span class="n">max_level</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">potentially_recursive_clusterization</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                                    <span class="n">clusterization_name</span><span class="o">=</span><span class="n">cluster_options</span><span class="o">.</span><span class="n">recursive_clusterization</span><span class="p">,</span>
                                                    <span class="n">inlets_object</span><span class="o">=</span><span class="n">inlets_object</span><span class="p">,</span>
                                                    <span class="n">spaths</span><span class="o">=</span><span class="n">spaths</span><span class="p">,</span>
                                                    <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span>
                                                    <span class="n">max_level</span><span class="o">=</span><span class="n">max_level</span><span class="p">)</span>


<span class="c1"># inlets_clusterization</span>
<div class="viewcode-block" id="stage_IV_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_IV_run">[docs]</a><span class="k">def</span> <span class="nf">stage_IV_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_of_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">coptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cluster_options</span><span class="p">()</span>
    <span class="n">rcoptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_recluster_options</span><span class="p">()</span>
    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>

    <span class="n">max_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">max_level</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">max_level</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="c1"># new style clustering</span>
    <span class="c1">#with clui.fbm(&quot;Create inlets&quot;):</span>
    <span class="c1"># here we can check center of system</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">SimpleProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span><span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Create inlets&quot;</span><span class="p">)</span>
    <span class="n">inls</span> <span class="o">=</span> <span class="n">Inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">center_of_system</span><span class="o">=</span><span class="n">center_of_system</span><span class="p">,</span> <span class="n">passing</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">exclude_passing_in_clusterization</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of inlets: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inls</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">noo</span><span class="p">():</span>
        <span class="c1"># returns number of outliers</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">inls</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># ***** CLUSTERIZATION *****</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Performing clusterization&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">potentially_recursive_clusterization</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                                 <span class="n">clusterization_name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">(),</span>
                                                 <span class="n">inlets_object</span><span class="o">=</span><span class="n">inls</span><span class="p">,</span>
                                                 <span class="n">spaths</span><span class="o">=</span><span class="n">spaths</span><span class="p">,</span>
                                                 <span class="n">message</span><span class="o">=</span><span class="s1">&#39;clusterization&#39;</span><span class="p">,</span>
                                                 <span class="n">max_level</span><span class="o">=</span><span class="n">max_level</span><span class="p">)</span>
        <span class="c1"># with log.fbm(&quot;Performing clusterization&quot;):</span>
        <span class="c1">#    clustering_function = get_clustering_method(coptions)</span>
        <span class="c1">#    inls.perform_clustering(clustering_function)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>
        <span class="c1"># ***** OUTLIERS DETECTION *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Detecting outliers&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Auto</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span>
                <span class="n">no_out_detected</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">,</span>
                                                <span class="n">inls</span><span class="o">.</span><span class="n">clusters_centers</span><span class="p">,</span>
                                                <span class="n">inls</span><span class="o">.</span><span class="n">clusters_std</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
                    <span class="n">dmat</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="c1"># Auto procedure</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span> <span class="ow">is</span> <span class="n">Auto</span><span class="p">:</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># FIXME: magic constant!</span>
                    <span class="c1"># defined threshold procedure</span>
                    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">inlets_ids</span><span class="p">)):</span>
                        <span class="c1"># print d, threshold</span>
                        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">no_out_detected</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Detected </span><span class="si">%d</span><span class="s1"> outliers.&#39;</span> <span class="o">%</span> <span class="n">no_out_detected</span><span class="p">)</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">add_outliers_annotations</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>
        <span class="c1"># ***** RECLUSTERIZATION *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">recluster_outliers</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Performing reclusterization of outliers&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                potentially_recursive_clusterization(config=config,</span>
<span class="sd">                                                 clusterization_name=config.recluster_name(),</span>
<span class="sd">                                                 inlets_object=inls,</span>
<span class="sd">                                                 spaths=spaths,</span>
<span class="sd">                                                 traj_reader=traj_reader,</span>
<span class="sd">                                                 message=&#39;reclusterization&#39;,</span>
<span class="sd">                                                 max_level=max_level)</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="n">clustering_function</span> <span class="o">=</span> <span class="n">get_clustering_method</span><span class="p">(</span><span class="n">rcoptions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="c1"># perform reclusterization</span>
                <span class="c1"># inls.recluster_outliers(clustering_function)</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">recluster_cluster</span><span class="p">(</span><span class="n">clustering_function</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>
        <span class="c1"># ***** SINGLETONS REMOVAL *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Removing clusters of size </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">)):</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">small_clusters_to_outliers</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>

        <span class="c1"># TODO: Move it after master paths!</span>
        <span class="c1"># ***** ADD PASSING PATHS TO CLUSTERS *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exclude_passing_in_clusterization</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">add_passing_to_clusters</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Adding passing paths inlets to clusters&quot;</span><span class="p">,</span><span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="c1"># passing paths were excluded and they are meant to be added</span>
                <span class="c1"># one need loop over clusters and then all passing paths have to checked</span>
                <span class="c1"># it is assumed taht adding method is barber</span>
                <span class="n">abo</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># ab from stage III</span>
                <span class="n">ab_options</span> <span class="o">=</span> <span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">abo</span><span class="p">)</span>
                <span class="n">ab_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
                <span class="c1"># get single paths only (no passing paths)</span>
                <span class="n">spaths_single</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">is_single</span><span class="p">()]</span>
                <span class="c1"># ids of passing paths</span>
                <span class="n">spaths_passing_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">is_passing</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_passing_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No passing paths to add.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># loop over passing paths, add to inlets</span>
                    <span class="n">inls</span><span class="o">.</span><span class="n">passing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">passing_inlets_ids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">passing_id</span> <span class="ow">in</span> <span class="n">spaths_passing_ids</span><span class="p">:</span>
                        <span class="n">passing_inlets_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">extend_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">[</span><span class="n">passing_id</span><span class="p">]))</span>
                    <span class="c1"># loop over clusters</span>
                    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
                        <span class="n">added_to_cluster</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Current cluster: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cluster</span><span class="p">)</span>
                        <span class="c1"># sps = inls.lim2clusters(cluster).limspaths2(spaths_single)</span>
                        <span class="c1"># chull = inls.lim2clusters(cluster).get_chull()</span>
                        <span class="n">wtc</span> <span class="o">=</span> <span class="n">WhereToCut</span><span class="p">(</span><span class="n">inlets</span><span class="o">=</span><span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">cluster</span><span class="p">),</span> <span class="o">**</span><span class="n">ab_options</span><span class="p">)</span>
                        <span class="n">wtc</span><span class="o">.</span><span class="n">cut_thyself</span><span class="p">()</span>
                        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">SimpleProgressBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">),</span><span class="s2">&quot;Loop over available passing paths inlets:&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">passing_inlet_nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">inlet</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">inlets_list</span><span class="p">[</span><span class="n">passing_inlets_ids</span><span class="p">[</span><span class="n">passing_inlet_nr</span><span class="p">]]</span>
                            <span class="n">sphere</span> <span class="o">=</span> <span class="n">wtc</span><span class="o">.</span><span class="n">inlet2sphere</span><span class="p">(</span><span class="n">inlet</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sphere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># if True:</span>
                                <span class="k">if</span> <span class="n">wtc</span><span class="o">.</span><span class="n">is_overlaping_with_cloud</span><span class="p">(</span><span class="n">sphere</span><span class="p">):</span>
                                    <span class="c1"># if chull.point_within(inlet.coords):</span>
                                    <span class="c1"># add this inlet to cluster!</span>
                                    <span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">passing_inlets_ids</span><span class="p">[</span><span class="n">passing_inlet_nr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster</span>
                                    <span class="n">added_to_cluster</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">passing_inlets_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">passing_inlet_nr</span><span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">added_to_cluster</span><span class="p">:</span>
                            <span class="n">inls</span><span class="o">.</span><span class="n">add_message_wrapper</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;+</span><span class="si">%d</span><span class="s1"> passing&#39;</span> <span class="o">%</span> <span class="n">added_to_cluster</span><span class="p">,</span> <span class="n">toleaf</span><span class="o">=</span><span class="n">cluster</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">):</span>
                        <span class="n">inls</span><span class="o">.</span><span class="n">add_message_wrapper</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;+</span><span class="si">%d</span><span class="s1"> passing&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">),</span> <span class="n">toleaf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Clustering history:&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">print_simple_tree</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Calculating cluster types&quot;</span><span class="p">):</span>
            <span class="n">ctypes</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">spaths2ctypes</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

        <span class="c1"># now, there is something to do with ctypes!</span>
        <span class="c1"># we can create master paths!</span>
        <span class="c1"># but only if user wants this</span>
        <span class="n">master_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">master_paths_smooth</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">create_master_paths</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Master paths calculations&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">smooth</span> <span class="o">=</span> <span class="n">get_smooth_method</span><span class="p">(</span><span class="n">soptions</span><span class="p">)</span>  <span class="c1"># this have to preceed GCS</span>
                <span class="k">if</span> <span class="n">GCS</span><span class="o">.</span><span class="n">cachedir</span> <span class="ow">or</span> <span class="n">GCS</span><span class="o">.</span><span class="n">cachemem</span><span class="p">:</span>
                    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Building coords cache&#39;</span><span class="p">)</span>
                    <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)]</span>
                    <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)]</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                    <span class="n">use_threads</span> <span class="o">=</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Master paths calculation without cache-dir or cache-mem option can be EXTREMELY slow.&quot;</span><span class="p">)</span>
                    <span class="n">use_threads</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Creating master paths for cluster types&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
                    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

                    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">))</span>
                        <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                        <span class="c1"># no passing paths are allowed</span>
                        <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)]</span> <span class="c1"># no PassingPaths!</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">), no single paths found, MasterPath calculation skipped.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">,))</span>
                            <span class="k">continue</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">), number of spaths </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)))</span>
                        <span class="c1"># print len(sps),ct</span>
                        <span class="n">ctspc</span> <span class="o">=</span> <span class="n">CTypeSpathsCollection</span><span class="p">(</span><span class="n">spaths</span><span class="o">=</span><span class="n">sps</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">ct</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">,</span>
                                                      <span class="n">threads</span><span class="o">=</span><span class="n">use_threads</span><span class="p">)</span>
                        <span class="n">master_paths</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">))})</span>
                        <span class="n">master_paths_smooth</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)})</span>
                        <span class="k">del</span> <span class="n">ctspc</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No inlets found. Clusterization skipped.&quot;</span><span class="p">)</span>
        <span class="c1"># make empty results</span>
        <span class="n">ctypes</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">spaths2ctypes</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
        <span class="n">master_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">master_paths_smooth</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;inls&#39;</span><span class="p">:</span> <span class="n">inls</span><span class="p">,</span>
            <span class="s1">&#39;ctypes&#39;</span><span class="p">:</span> <span class="n">ctypes</span><span class="p">,</span>
            <span class="s1">&#39;master_paths&#39;</span><span class="p">:</span> <span class="n">master_paths</span><span class="p">,</span></div>
            <span class="s1">&#39;master_paths_smooth&#39;</span><span class="p">:</span> <span class="n">master_paths_smooth</span><span class="p">}</span>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">make_line</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="c1"># detect nan and int problem</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">line</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">template</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
                    <span class="n">line</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nan&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template</span><span class="p">))</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_header_template</span><span class="p">(</span><span class="n">line_template</span><span class="p">):</span>
    <span class="n">header_template</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">col_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line_template</span><span class="p">:</span>
        <span class="n">header_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">header_template</span>


<span class="k">def</span> <span class="nf">nr_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Nr&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_header_line_and_line_template</span><span class="p">(</span><span class="n">header_line_and_line_template</span><span class="p">,</span> <span class="n">head_nr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">header_line_and_line_template</span>

    <span class="n">header_template</span> <span class="o">=</span> <span class="n">make_header_template</span><span class="p">(</span><span class="n">line_template</span><span class="p">)</span>
    <span class="c1"># head_nr? only to header</span>
    <span class="k">if</span> <span class="n">head_nr</span><span class="p">:</span>
        <span class="n">nrh</span><span class="p">,</span> <span class="n">nrlt</span> <span class="o">=</span> <span class="n">nr_header</span><span class="p">()</span>
        <span class="n">header_template</span> <span class="o">=</span> <span class="n">make_header_template</span><span class="p">(</span><span class="n">nrlt</span> <span class="o">+</span> <span class="n">line_template</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">nrh</span> <span class="o">+</span> <span class="n">header</span>
    <span class="n">header_line</span> <span class="o">=</span> <span class="n">make_line</span><span class="p">(</span><span class="n">header_template</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span>


<span class="k">def</span> <span class="nf">spath_id_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9s</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">spath_name_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;RES&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%4s</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_path_id_head</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="n">sph</span><span class="p">,</span> <span class="n">splt</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spath_id_header</span><span class="p">(),</span> <span class="n">spath_name_header</span><span class="p">())</span>
    <span class="n">sph</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sph</span><span class="p">]</span>
    <span class="n">splt</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">splt</span><span class="p">]</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">add_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;add_id&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">add_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;add_id&#39;</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sph</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">splt</span> <span class="o">+</span> <span class="n">lt</span>
        <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">lt</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">add_path_id</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">add_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;add_id&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">add_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;add_id&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_id</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">size_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="s1">&#39;Size%&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%6.2f</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_size_head</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="n">sph</span><span class="p">,</span> <span class="n">splt</span> <span class="o">=</span> <span class="n">size_header</span><span class="p">()</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sph</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">splt</span> <span class="o">+</span> <span class="n">lt</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">add_size</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">add_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_size_p100</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">add_size_p100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">if</span> <span class="n">add_size</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">cluster_id_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_cluster_id_head</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="n">sph</span><span class="p">,</span> <span class="n">splt</span> <span class="o">=</span> <span class="n">cluster_id_header</span><span class="p">()</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sph</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">splt</span> <span class="o">+</span> <span class="n">lt</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">add_cluster_id</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">something</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">something</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_id</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cluster</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">ctype_id_header</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;CType&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7s</span><span class="s1">&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_ctype_id_head</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="n">sph</span><span class="p">,</span> <span class="n">splt</span> <span class="o">=</span> <span class="n">ctype_id_header</span><span class="p">()</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sph</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">splt</span> <span class="o">+</span> <span class="n">lt</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">def</span> <span class="nf">add_ctype_id</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">patched</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">something</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">something</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_id</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ctype</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="k">return</span> <span class="n">patched</span>


<span class="k">class</span> <span class="nc">PrintAnalysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">nr_template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> &#39;</span>

    <span class="c1"># TODO: Change it in such a way that it cooperates well with debug-file option.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileoption</span><span class="p">,</span> <span class="n">line_nr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output2stderr</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">fileoption</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileoption</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="c1"># self.output2stderr = True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_nr</span> <span class="o">=</span> <span class="n">line_nr</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info2print</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_nr</span> <span class="ow">and</span> <span class="n">nr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info2print</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_template</span> <span class="o">%</span> <span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="n">info2print</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output2stderr</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">info2print</span><span class="p">)</span>
        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">filehandle</span><span class="p">,</span> <span class="n">info2print</span>

    <span class="k">def</span> <span class="nf">sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="n">asep</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">thead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info2print</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">info2print</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info2print</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">tsep</span><span class="p">(</span><span class="n">info2print</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">under</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info2print</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">info2print</span><span class="p">))</span>


<span class="c1">################################################################################</span>

<span class="nd">@add_path_id_head</span>
<span class="k">def</span> <span class="nf">spath_basic_info_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;BeginF InpF ObjF OutF EndF&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_basic_info</span><span class="p">(</span><span class="n">spath</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">begins</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">path_in</span><span class="p">,</span> <span class="n">spath</span><span class="o">.</span><span class="n">path_object</span><span class="p">,</span> <span class="n">spath</span><span class="o">.</span><span class="n">path_out</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">ends</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################</span>

<span class="nd">@add_path_id_head</span>
<span class="k">def</span> <span class="nf">spath_lenght_total_info_header</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;InpL ObjL OutL&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TotL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_lenght_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># total and totalonly are internal flags</span>
    <span class="c1"># to calculate: total len, in len, obj len, out len call:</span>
    <span class="c1"># total=True (this will calculate total)</span>
    <span class="c1"># to skip calculation of total call:</span>
    <span class="c1"># total=False, totalonly=False (this will calculate in, obj, and out lens)</span>
    <span class="c1"># to calculate total len call:</span>
    <span class="c1"># total=False, totalonly=True</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">totalonly</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">traces</span><span class="o">.</span><span class="n">midpoints</span><span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># traces.length_step_std requires at least 2 points</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">length_step_std</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">traces</span><span class="o">.</span><span class="n">midpoints</span><span class="p">((</span><span class="n">spath</span><span class="o">.</span><span class="n">coords_cont</span><span class="p">,)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># traces.length_step_std requires at least 2 points</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">length_step_std</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_frames_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># total and totalonly are internal flags</span>
    <span class="c1"># to calculate: total len, in len, obj len, out len call:</span>
    <span class="c1"># total=True (this will calculate total)</span>
    <span class="c1"># to skip calculation of total call:</span>
    <span class="c1"># total=False, totalonly=False (this will calculate in, obj, and out lens)</span>
    <span class="c1"># to calculate total len call:</span>
    <span class="c1"># total=False, totalonly=True</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">totalonly</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spath</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">coords_cont</span><span class="p">,):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_frames_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_frames_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################</span>

<span class="nd">@add_path_id_head</span>
<span class="k">def</span> <span class="nf">spath_steps_info_header</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;InpS InpStdS ObjS ObjStdS OutS OutStdS&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TotS&#39;</span><span class="p">,</span> <span class="s1">&#39;TotStdS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%8.2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%8.3f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_steps_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">traces</span><span class="o">.</span><span class="n">midpoints</span><span class="p">(</span><span class="n">spath</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">length_step_std</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_steps_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">midpoints</span><span class="p">((</span><span class="n">spath</span><span class="o">.</span><span class="n">coords_cont</span><span class="p">,))</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">length_step_std</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_frames_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spath</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">spath_steps_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">spath</span><span class="o">.</span><span class="n">coords_cont</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">line</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################</span>

<span class="nd">@add_path_id_head</span>
<span class="k">def</span> <span class="nf">spath_ctype_header</span><span class="p">():</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">ctype_id_header</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_ctype</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ctype</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################</span>

<span class="nd">@add_path_id_head</span>
<span class="k">def</span> <span class="nf">spath_full_info_header</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">lt</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spath_basic_info_header</span><span class="p">(</span><span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                  <span class="n">spath_lenght_total_info_header</span><span class="p">(</span><span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">),</span>
                  <span class="n">spath_steps_info_header</span><span class="p">(</span><span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">),</span>
                  <span class="n">spath_ctype_header</span><span class="p">(</span><span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="n">h</span>
        <span class="n">line_template</span> <span class="o">+=</span> <span class="n">lt</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_path_id</span>
<span class="k">def</span> <span class="nf">spath_full_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">spath_basic_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
              <span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">),</span>
              <span class="n">spath_steps_info</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">),</span>
              <span class="n">spath_ctype</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################################################################################</span>

<span class="nd">@add_size_head</span>
<span class="k">def</span> <span class="nf">spaths_lenght_total_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;Tot TotStd Inp InpStd Obj ObjStd Out OutStd&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%9.2f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_size</span>
<span class="k">def</span> <span class="nf">spaths_length_total</span><span class="p">(</span><span class="n">spaths</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
            <span class="n">d4s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d4s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d4s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">6</span>
    <span class="c1"># total</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="n">d4s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d4s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d4s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>


<span class="nd">@add_size</span>
<span class="k">def</span> <span class="nf">spaths_frames_total</span><span class="p">(</span><span class="n">spaths</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
            <span class="n">d4s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath_frames_total_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d4s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d4s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">6</span>
    <span class="c1"># total</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="n">d4s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spath_frames_total_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">d4s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d4s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d4s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d4s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>


<span class="c1">################################################################################</span>


<span class="nd">@add_cluster_id_head</span>
<span class="k">def</span> <span class="nf">clusters_inlets_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;Size SInp IInp IOut SOut&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;Size INCOMING OUTGOING&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%8d</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_cluster_id</span>
<span class="k">def</span> <span class="nf">clusters_inlets</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">inlets</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">inlets</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inlets</span><span class="o">.</span><span class="n">lim2types</span><span class="p">([</span><span class="n">InletTypeCodes</span><span class="o">.</span><span class="n">surface_incoming</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># line.append(inlets.lim2types([InletTypeCodes.internal_incoming]).size)</span>
    <span class="c1"># line.append(inlets.lim2types([InletTypeCodes.internal_outgoing]).size)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inlets</span><span class="o">.</span><span class="n">lim2types</span><span class="p">([</span><span class="n">InletTypeCodes</span><span class="o">.</span><span class="n">surface_outgoing</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################################################################################</span>

<span class="nd">@add_ctype_id_head</span>
<span class="k">def</span> <span class="nf">ctypes_spaths_info_header</span><span class="p">():</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">spaths_lenght_total_header</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_ctype_id</span>
<span class="k">def</span> <span class="nf">ctypes_spaths_info</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">spaths</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># show could be len or frames</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="s1">&#39;len&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">spaths_length_total</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">add_size_p100</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="s1">&#39;frames&#39;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">spaths_frames_total</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">add_size_p100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################################################################################</span>


<span class="nd">@add_cluster_id_head</span>
<span class="k">def</span> <span class="nf">clusters_stats_prob_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;IN-OUT diff N IN-OUT_prob diff_prob N_prob&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%8d</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%12.2f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># header += &#39;IN_len OUT_len Both_len&#39;.split()</span>
    <span class="c1"># line_template += [&#39;%9.1f&#39;] * 3</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_cluster_id</span>
<span class="k">def</span> <span class="nf">clusters_stats_prob</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">sp_ct</span><span class="p">):</span>
    <span class="c1"># calculates probabilities of some events for cluster</span>
    <span class="c1"># X:X transition - io</span>
    <span class="c1"># X:? and ?:X transition - d</span>
    <span class="c1"># X:N and N:X transition - N</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">io</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span><span class="p">,</span> <span class="n">tot_len</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="n">in_n</span><span class="p">,</span> <span class="n">out_n</span><span class="p">,</span> <span class="n">tot_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">sp_ct</span><span class="p">:</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">clusters</span>
        <span class="k">assert</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">ct</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">io</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">ct</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="n">io</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span>
    <span class="n">summa</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">io</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">]))</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">summa</span> <span class="k">if</span> <span class="n">summa</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">io</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">line</span>


<span class="nd">@add_cluster_id_head</span>
<span class="k">def</span> <span class="nf">clusters_stats_len_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;X-&gt;Obj Obj-&gt;X p-value X-&gt;ObjMin X-&gt;ObjMinID Obj-&gt;XMin Obj-&gt;XMinID&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.4f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%11s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_cluster_id</span>
<span class="k">def</span> <span class="nf">clusters_stats_len</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">sp_ct</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">in_len_min</span><span class="p">,</span> <span class="n">out_len_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">in_len_min_id</span><span class="p">,</span> <span class="n">out_len_min_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">sp_ct</span><span class="p">:</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">clusters</span>
        <span class="k">assert</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">ct</span>
        <span class="n">lens</span> <span class="o">=</span> <span class="n">spath_lenght_total_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># tot,in,obj,out</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">in_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">in_len_min</span><span class="p">:</span>
                    <span class="n">in_len_min</span> <span class="o">=</span> <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">in_len_min_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">out_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">out_len_min</span><span class="p">:</span>
                    <span class="n">out_len_min</span> <span class="o">=</span> <span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">out_len_min_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_len</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">in_len</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_len</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_len</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># this is supposed to return p-value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="n">in_len_min</span><span class="p">,</span> <span class="n">in_len_min_id</span><span class="p">,</span> <span class="n">out_len_min</span><span class="p">,</span> <span class="n">out_len_min_id</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">line</span>


<span class="nd">@add_cluster_id_head</span>
<span class="k">def</span> <span class="nf">clusters_stats_steps_header</span><span class="p">():</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;X-&gt;Obj Obj-&gt;X p-value X-&gt;ObjMin X-&gt;ObjMinID Obj-&gt;XMin Obj-&gt;XMinID&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">line_template</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.4f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%9.1f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%11s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">line_template</span>


<span class="nd">@add_cluster_id</span>
<span class="k">def</span> <span class="nf">clusters_stats_steps</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">sp_ct</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">in_len_min</span><span class="p">,</span> <span class="n">out_len_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">in_len_min_id</span><span class="p">,</span> <span class="n">out_len_min_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">sp_ct</span><span class="p">:</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">clusters</span>
        <span class="k">assert</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">ct</span>
        <span class="n">lens</span> <span class="o">=</span> <span class="n">spath_frames_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">add_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># tot,in,obj,out</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">in_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">in_len_min</span><span class="p">:</span>
                    <span class="n">in_len_min</span> <span class="o">=</span> <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">in_len_min_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">out_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">out_len_min</span><span class="p">:</span>
                    <span class="n">out_len_min</span> <span class="o">=</span> <span class="n">lens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">out_len_min_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_len</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">in_len</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_len</span><span class="p">):</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">out_len</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">in_len</span><span class="p">,</span> <span class="n">out_len</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># this is supposed to return p-value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">))</span>

    <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="n">in_len_min</span><span class="p">,</span> <span class="n">in_len_min_id</span><span class="p">,</span> <span class="n">out_len_min</span><span class="p">,</span> <span class="n">out_len_min_id</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">line</span>


<span class="c1">################################################################################</span>


<span class="c1"># analysis</span>
<div class="viewcode-block" id="stage_V_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_V_run">[docs]</a><span class="k">def</span> <span class="nf">stage_V_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">inls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">ctypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># file handle?</span>
    <span class="n">head_nr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">line_nr</span> <span class="o">=</span> <span class="n">head_nr</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">PrintAnalysis</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">line_nr</span><span class="o">=</span><span class="n">line_nr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Using user provided file (</span><span class="si">%s</span><span class="s1">), and&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;for histograms data file (</span><span class="si">%s</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Using standard output.&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;Aqua-Duct analysis&#39;</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">get_str_timestamp</span><span class="p">())</span>

    <span class="c1">############</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dump_config</span><span class="p">:</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">under</span><span class="p">(</span><span class="s1">&#39;Configuration file name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dump_config</span><span class="p">()))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Frames window: </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2"> step </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                         <span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                         <span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>

    <span class="c1">############</span>
    <span class="n">traced_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">]))))</span>
    <span class="c1"># traced_names = [&#39;all&#39;] + traced_names</span>

    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Names of traced molecules: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)))</span>

    <span class="c1"># spaths_types = [&#39;all&#39;]</span>
    <span class="n">spaths_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">PassingPath</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="n">spaths_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PassingPath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">SinglePath</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="n">spaths_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SinglePath</span><span class="p">)</span>
    <span class="n">spaths_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span>

    <span class="c1">############</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">traced_names</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_tname</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_tname</span><span class="p">,),</span> <span class="s2">&quot; of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_tname</span>

    <span class="k">def</span> <span class="nf">iter_over_tnspt</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_message</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">spaths_types</span><span class="p">,</span> <span class="n">_message</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_sptype</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">PassingPath</span><span class="p">:</span>
                        <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;passing paths&#39;</span>
                    <span class="k">elif</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">SinglePath</span><span class="p">:</span>
                        <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;object  paths&#39;</span>
                    <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="p">(</span><span class="n">_sptype</span><span class="p">,),</span> <span class="n">_message</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_sptype_name</span><span class="p">)</span>

    <span class="c1">############</span>

    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of traceable residues</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
           <span class="p">(</span><span class="n">message</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of separate paths</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
           <span class="p">(</span><span class="n">message</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">))])))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of inlets</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="n">no_of_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="mi">0</span><span class="p">}[</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">]</span>  <span class="c1"># minus outliers, if any</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of clusters: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">no_of_clusters</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Outliers: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;no&#39;</span><span class="p">}[</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">]))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;Clustering history:&#39;</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">print_simple_tree</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_inlets_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters summary - inlets</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span>
                <span class="n">cl</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_inlets</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">inls_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="c1">############</span>
    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_prob_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) probabilities of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_prob</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_len_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean lengths of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_len</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_steps_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean frames numbers of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_steps</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">ctypes_spaths_info_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>

    <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

    <span class="c1"># sorted by ctype</span>
    <span class="n">ctypes_size</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
        <span class="n">ctypes_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes_generic_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ctypes_size</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean lengths of paths</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
            <span class="c1"># ctypes_size.append(len(sps))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;len&quot;</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean number of frames of paths</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
            <span class="c1"># ctypes_size.append(len(sps))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;frames&quot;</span><span class="p">)),</span>
                   <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;List of separate paths and properties&quot;</span><span class="p">)</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">spath_full_info_header</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ctype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip_longest</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">ctype</span><span class="o">.</span><span class="n">generic</span>
        <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">spath_full_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="c1"># additional analysis</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">traced_names</span><span class="p">,</span> <span class="s1">&#39;amol&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_tname</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_tname</span><span class="p">,),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_tname</span>

    <span class="k">def</span> <span class="nf">iter_over_part</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_part</span> <span class="ow">in</span> <span class="s1">&#39;walk in object out&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;in out&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_part</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_message</span> <span class="o">=</span> <span class="n">_part</span>
                <span class="n">_part</span> <span class="o">=</span> <span class="p">[</span><span class="n">_part</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>

    <span class="k">def</span> <span class="nf">iter_over_spt</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">spaths_types</span><span class="p">,</span> <span class="s1">&#39;apaths&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_sptype</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">PassingPath</span><span class="p">:</span>
                    <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;passing&#39;</span>
                <span class="k">elif</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">SinglePath</span><span class="p">:</span>
                    <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_sptype</span><span class="p">,),</span> <span class="n">_sptype_name</span>

    <span class="k">def</span> <span class="nf">iter_over_c</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s1">&#39;aclusts&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_cluster</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="p">[</span><span class="n">_cluster</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">_cluster</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_ct</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">ctypes_generic_list</span><span class="p">,</span> <span class="s1">&#39;actypes&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_cluster</span> <span class="ow">in</span> <span class="n">ctypes_generic_list</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_cluster</span><span class="p">,),</span> <span class="nb">str</span><span class="p">(</span><span class="n">_cluster</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_all</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_m_tname</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_m_sptype</span> <span class="ow">in</span> <span class="n">iter_over_spt</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">_cluster</span><span class="p">,</span> <span class="n">_m_cluster</span> <span class="ow">in</span> <span class="n">iter_over_c</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_m_part</span> <span class="ow">in</span> <span class="n">iter_over_part</span><span class="p">():</span>
                        <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">_m_tname</span><span class="p">,</span>
                                             <span class="n">_m_sptype</span><span class="p">,</span>
                                             <span class="n">_m_cluster</span><span class="p">,</span>
                                             <span class="n">_m_part</span><span class="p">))</span>
                        <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_cluster</span><span class="p">,</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>
                <span class="k">for</span> <span class="n">_ctype</span><span class="p">,</span> <span class="n">_m_ctype</span> <span class="ow">in</span> <span class="n">iter_over_ct</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_m_part</span> <span class="ow">in</span> <span class="n">iter_over_part</span><span class="p">():</span>
                        <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">_m_tname</span><span class="p">,</span>
                                             <span class="n">_m_sptype</span><span class="p">,</span>
                                             <span class="n">_m_ctype</span><span class="p">,</span>
                                             <span class="n">_m_part</span><span class="p">))</span>
                        <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_ctype</span><span class="p">,</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>

    <span class="c1"># histograms</span>
    <span class="c1"># calculate old max_frame</span>
    <span class="n">max_frame</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">iter_over_all</span><span class="p">()]</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_frame</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
    <span class="c1"># loop over spaths</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span>
                     <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Calculating histograms&#39;</span><span class="p">)</span>
    <span class="c1"># loop over paths and ctypes</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">):</span>
        <span class="c1"># loop over columns</span>
        <span class="c1"># traced names, paths types, clusters cluster types, part of paths, column name</span>
        <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">c_ct</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">iter_over_all</span><span class="p">():</span>
            <span class="c1"># check if column fits to the requirements</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c1"># c or ct</span>
            <span class="n">it_is_ct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">InletClusterGenericType</span><span class="p">):</span>
                <span class="n">it_is_ct</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">union_full</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span> <span class="n">c_ct</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># this is more than that...</span>
            <span class="c1"># if c_ct is not InletClusterGenericType then:</span>
            <span class="c1"># if &#39;in&#39; in part only incoming paths in ct are used</span>
            <span class="c1"># if &#39;out&#39; in part only outgoing paths in ct are used</span>
            <span class="n">col_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;walk&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">paths_cont</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;in&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">it_is_ct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">input</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_in</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;object&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_object</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;out&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">it_is_ct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">output</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_out</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1"># scope/object size?</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">calculate_scope_object_size</span><span class="p">:</span>
        <span class="n">scope_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">object_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># now, the problem is in the scope and object definition.</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(),</span> <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Calculating scope and object sizes&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">scope_size</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">object_size</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">iterate_over_frames</span><span class="p">():</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope_chull</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                <span class="n">scope_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">object_chull</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                <span class="n">object_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">number</span><span class="p">),</span>
                          <span class="p">[</span><span class="s1">&#39;scope_area&#39;</span><span class="p">,</span> <span class="s1">&#39;scope_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;object_area&#39;</span><span class="p">,</span> <span class="s1">&#39;object_volume&#39;</span><span class="p">])</span>
            <span class="n">fmt</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">s_s</span><span class="p">,</span> <span class="n">o_s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scope_size</span><span class="p">,</span> <span class="n">object_size</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">s_s</span><span class="p">,</span> <span class="n">o_s</span><span class="p">))</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="c1"># add frame column?</span>
    <span class="n">frame_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">max_frame</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">frame_col</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fmt</span>
    <span class="c1"># save???</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="n">h_fname</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">cStringIO</span> <span class="k">as</span> <span class="nn">StringIO</span>
        <span class="n">h_fname</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">h_fname</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span>
               <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span>
               <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
               <span class="n">header</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">h_fname</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</div>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">}</span>


<span class="c1">################################################################################</span>

<span class="c1"># visualize</span>


<span class="k">def</span> <span class="nf">plot_spaths_traces</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">states</span> <span class="ow">or</span> <span class="n">separate</span><span class="p">:</span>
        <span class="n">spaths_iter</span> <span class="o">=</span> <span class="n">spaths</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spaths_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">spaths</span><span class="p">]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name_separate</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spaths_iter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
            <span class="n">name_separate</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">states</span> <span class="ow">or</span> <span class="n">separate</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="c1"># FIXME: if path(s) is empty this will probably produce CGO_END without CGO_BEGIN</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">paths_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_in&#39;</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">plot_walk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">paths_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_obj&#39;</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">plot_walk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_in</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">paths_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_out&#39;</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">plot_walk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_in</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">paths_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_walk&#39;</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">plot_in</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">paths_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_spaths_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">states</span> <span class="ow">or</span> <span class="n">separate</span><span class="p">:</span>
        <span class="n">spaths_iter</span> <span class="o">=</span> <span class="n">spaths</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spaths_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">spaths</span><span class="p">]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name_separate</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spaths_iter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
            <span class="n">name_separate</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">states</span> <span class="ow">or</span> <span class="n">separate</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
        <span class="n">spp</span><span class="o">.</span><span class="n">paths_inlets</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="n">name_separate</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_pymol_connector_session</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">session_ext</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[.][pP][sS][eE]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">session_ext</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_pymol_connector_script</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.*[.]([pP][yY]|[.pP][yY][.][gG][zZ])$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="stage_VI_run"><a class="viewcode-back" href="../../../aquaduct.apps.valvecore.html#aquaduct.apps.valvecore.stage_VI_run">[docs]</a><span class="k">def</span> <span class="nf">stage_VI_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">inls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ctypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">master_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">master_paths_smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">aquaduct.visual.pymol_connector</span> <span class="k">import</span> <span class="n">ConnectToPymol</span><span class="p">,</span> <span class="n">SinglePathPlotter</span>
    <span class="c1"># from aquaduct.visual.pymol_connector import cmd as pymol_cmd</span>
    <span class="kn">from</span> <span class="nn">aquaduct.visual.helpers</span> <span class="k">import</span> <span class="n">ColorMapDistMap</span>

    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="n">get_smooth_method</span><span class="p">(</span><span class="n">soptions</span><span class="p">)</span>

    <span class="c1"># start pymol</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Starting PyMOL connection&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">pymol_connector</span> <span class="o">=</span> <span class="n">ConnectToPymol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_pymol_connector_script</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">init_script</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">init_pymol</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">simply_smooths</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">SinglePathPlotter</span><span class="p">(</span><span class="n">pymol_connector</span><span class="p">,</span> <span class="n">linearize</span><span class="o">=</span><span class="n">get_linearize_method</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">simply_smooths</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">SinglePathPlotter</span><span class="p">(</span><span class="n">pymol_connector</span><span class="p">,</span> <span class="n">linearize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">:</span>
        <span class="n">molecule_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Molecule&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">()):</span>
                <span class="c1"># mda_ppr = mda.core.flags[&quot;permissive_pdb_reader&quot;]</span>
                <span class="c1"># mda.core.flags[&quot;permissive_pdb_reader&quot;] = False #mda16 it is porbably always True</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_molecule_frames</span><span class="p">)</span>
                <span class="n">pdbfile</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">dump_frames</span><span class="p">(</span><span class="n">frames_to_show</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">)</span>
                <span class="n">pymol_connector</span><span class="o">.</span><span class="n">load_pdb</span><span class="p">(</span><span class="s1">&#39;molecule</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">pdbfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">molecule_name</span> <span class="o">=</span> <span class="s1">&#39;molecule</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>
                <span class="c1"># it would be nice to plot convexhull</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Convexhull&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">()):</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_frames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_show</span><span class="p">:</span>
                    <span class="n">traj_reader</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull</span><span class="p">)</span>
                    <span class="n">chull</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">chull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">convexhull</span><span class="p">(</span><span class="n">chull</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;scope_shape</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Scope convex hull calculations failed for frame </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_object_chull</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Object shape&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">()):</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_frames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_show</span><span class="p">:</span>
                    <span class="n">traj_reader</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">object_shape</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_object_chull</span><span class="p">)</span>
                    <span class="n">chull</span> <span class="o">=</span> <span class="n">object_shape</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">chull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">convexhull</span><span class="p">(</span><span class="n">chull</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;object_shape</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span>
                                       <span class="n">state</span><span class="o">=</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># orange</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Object convex hull calculations failed for frame </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_clusters</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Clusters&quot;</span><span class="p">):</span>
            <span class="c1"># TODO: require stage V for that?</span>
            <span class="n">no_of_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">)</span>  <span class="c1"># total, including outliers</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ColorMapDistMap</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
                <span class="c1"># coords for current cluster</span>
                <span class="n">ics</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ics</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># TODO: This does not work any more in that way. Rewrite it or remove it</span>
                    <span class="n">radii</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">radii</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ics</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_radii_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">c_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">ctypes_raw</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;CTypes raw&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">sps</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">master_paths</span><span class="p">[</span><span class="n">ct</span><span class="p">]],</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw_master&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">ctypes_smooth</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;CTypes smooth&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">sps</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_smooth&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">ct</span><span class="p">]],</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_smooth_master&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                       <span class="n">smooth</span><span class="o">=</span><span class="k">lambda</span> <span class="n">anything</span><span class="p">:</span> <span class="n">anything</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">master_paths</span><span class="p">[</span><span class="n">ct</span><span class="p">]],</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw_master_smooth&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                       <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_raw</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All raw paths&quot;</span><span class="p">):</span>
            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_raw&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">all_paths_split</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_raw_io</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All raw paths io&quot;</span><span class="p">):</span>
            <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_raw_paths_io&#39;</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_smooth</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All smooth paths&quot;</span><span class="p">):</span>
            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_smooth&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">all_paths_split</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_smooth_io</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All smooth paths io&quot;</span><span class="p">):</span>
            <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_smooth_paths_io&#39;</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Paths as states&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_raw</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;raw_paths&#39;</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                               <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_smooth</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth_paths&#39;</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                               <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_raw_io</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;raw_io&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;raw_paths_io&#39;</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                               <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_smooth_io</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;smooth_io&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth_paths_io&#39;</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                               <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">:</span>
        <span class="n">pymol_connector</span><span class="o">.</span><span class="n">orient_on</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_pymol_connector_session</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Saving session (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># new line</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span>
            <span class="c1"># FIXME: Loop over states is not required if there is no object with many states.</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Finalizing session saving...&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># new line</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="c1">################################################################################</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;clui</span>
<span class="s1">optimal_threads</span>
<span class="s1">aquaduct_version_nice</span>
<span class="s1">ValveConfig</span>
<span class="s1">valve_begin</span>
<span class="s1">valve_load_config</span>
<span class="s1">valve_exec_stage</span>
<span class="s1">stage_I_run</span>
<span class="s1">stage_II_run</span>
<span class="s1">stage_III_run</span>
<span class="s1">stage_IV_run</span>
<span class="s1">stage_V_run</span>
<span class="s1">stage_VI_run</span>
<span class="s1">valve_end</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Aqua-Duct 0.5.14 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../aquaduct.html" >aquaduct</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, 2017, 2018 Tomasz Magdziarz, Karolina Mitusińska, Agata Raczyńska, Artur Góra.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.1.
    </div>
  </body>
</html>