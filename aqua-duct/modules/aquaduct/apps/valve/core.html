

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aquaduct.apps.valve.core &#8212; Aqua-Duct 1.0.2 documentation</title>
    <link rel="stylesheet" href="../../../../static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../../../static/ficon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Aqua-Duct 1.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../aquaduct.html" >aquaduct</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../valve.html" accesskey="U">aquaduct.apps.valve</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../static/AQUADUCT_LOGO.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for aquaduct.apps.valve.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># Aqua-Duct, a tool facilitating analysis of the flow of solvent molecules in molecular dynamic simulations</span>
<span class="c1"># Copyright (C) 2016-2018  Tomasz Magdziarz, Alicja Płuciennik, Michał Stolarczyk &lt;info@aquaduct.pl&gt;</span>
<span class="c1"># Copyright (C) 2019  Tomasz Magdziarz, Michał Banas &lt;info@aquaduct.pl&gt;</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip_longest</span><span class="p">,</span> <span class="n">izip</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">imap</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Process</span>

<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="k">import</span> <span class="n">cdist</span>

<span class="kn">from</span> <span class="nn">aquaduct</span> <span class="k">import</span> <span class="n">version_nice</span> <span class="k">as</span> <span class="n">aquaduct_version_nice</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.data</span> <span class="k">import</span> <span class="n">GCS</span><span class="p">,</span> <span class="n">save_cric</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.valve</span> <span class="k">import</span> <span class="n">sep</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.valve.data</span> <span class="k">import</span> <span class="n">get_vda_reader</span>
<span class="kn">from</span> <span class="nn">aquaduct.geom.master</span> <span class="k">import</span> <span class="n">CTypeSpathsCollection</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.barber</span> <span class="k">import</span> <span class="n">barber_paths</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.inlets</span> <span class="k">import</span> <span class="n">InletClusterGenericType</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.inlets</span> <span class="k">import</span> <span class="n">Inlets</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.paths</span> <span class="k">import</span> <span class="n">GenericPaths</span><span class="p">,</span> <span class="n">yield_single_paths</span><span class="p">,</span> <span class="n">SinglePath</span><span class="p">,</span> <span class="n">MacroMolPath</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.paths</span> <span class="k">import</span> <span class="n">yield_generic_paths</span><span class="p">,</span> <span class="n">correct_spaths_ids</span>
<span class="kn">from</span> <span class="nn">aquaduct.traj.sandwich</span> <span class="k">import</span> <span class="n">ResidueSelection</span><span class="p">,</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">mda_ver</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.clui</span> <span class="k">import</span> <span class="n">roman</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.helpers</span> <span class="k">import</span> <span class="n">iterate_or_die</span><span class="p">,</span> <span class="n">fractionof</span><span class="p">,</span> <span class="n">make_fractionof</span><span class="p">,</span> <span class="n">make_fraction</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.helpers</span> <span class="k">import</span> <span class="n">range2int</span><span class="p">,</span> <span class="n">what2what</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">robust_and</span><span class="p">,</span> <span class="n">robust_or</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.multip</span> <span class="k">import</span> <span class="n">optimal_threads</span>
<span class="kn">from</span> <span class="nn">aquaduct.utils.sets</span> <span class="k">import</span> <span class="n">intersection_full</span>

<span class="kn">from</span> <span class="nn">aquaduct.apps.valve.worker</span> <span class="k">import</span> <span class="n">stage_I_worker_q</span><span class="p">,</span> <span class="n">stage_II_worker_q</span><span class="p">,</span> <span class="n">stage_II_worker_q_twoways</span><span class="p">,</span> \
    <span class="n">assign_nonsandwiched_paths</span><span class="p">,</span> <span class="n">assign_sandwiched_paths</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.valve.helpers</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.valve.spath</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">aquaduct.apps.valve.clusters</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">aquaduct.visual</span> <span class="k">import</span> <span class="n">cmaps</span>

<span class="n">__mail__</span> <span class="o">=</span> <span class="s1">&#39;info@aquaduct.pl&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">aquaduct_version_nice</span><span class="p">()</span>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">valve_begin_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Starting Stage </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roman</span><span class="o">.</span><span class="n">toRoman</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">)))</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Execute mode: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">options</span>


<div class="viewcode-block" id="valve_exec_stage"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.valve_exec_stage">[docs]</a><span class="k">def</span> <span class="nf">valve_exec_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">stage_run</span><span class="p">,</span> <span class="n">no_io</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">tictoc</span><span class="p">(</span><span class="s1">&#39;Stage </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roman</span><span class="o">.</span><span class="n">toRoman</span><span class="p">(</span><span class="n">stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">stage_names</span><span class="p">(</span><span class="n">stage</span><span class="p">))):</span>

        <span class="c1"># This function runs stages in a smart way, checks execution logic, and loads/saves dumps if required.</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">valve_begin_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">run_status</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">stage</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># TODO: Consider to create traj_reader object here instead of doing it in stage_run or in load...</span>
        <span class="c1"># execute?</span>
        <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_io</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># has to be run?</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">can_be_loaded</span> <span class="ow">and</span> <span class="n">stage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run_status</span><span class="p">[</span><span class="n">stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">can_be_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">can_be_loaded</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stage_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">save_cric</span><span class="p">()</span>
            <span class="n">run_status</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">stage</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
                <span class="c1">###########</span>
                <span class="c1"># S A V E #</span>
                <span class="c1">###########</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Saving data dump in </span><span class="si">%s</span><span class="s1"> file&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                    <span class="n">vda</span> <span class="o">=</span> <span class="n">get_vda_reader</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="n">vda</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
                <span class="c1"># save_stage_dump(options.dump, **result)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;skip&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">execute</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;runonce&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">can_be_loaded</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
                <span class="c1">###########</span>
                <span class="c1"># L O A D #</span>
                <span class="c1">###########</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Loading data dump from </span><span class="si">%s</span><span class="s1"> file&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">):</span>
                        <span class="n">vda</span> <span class="o">=</span> <span class="n">get_vda_reader</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">vda</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="c1"># result = load_stage_dump(options.dump, reader=reader)</span>
                    <span class="k">if</span> <span class="n">force_save</span><span class="p">:</span>
                        <span class="c1">######################</span>
                        <span class="c1"># F O R C E  S A V E #</span>
                        <span class="c1">######################</span>
                        <span class="k">if</span> <span class="n">force_save</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dump&#39;</span><span class="p">,</span> <span class="s1">&#39;nc&#39;</span><span class="p">]:</span>
                            <span class="n">fs_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">dump</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">force_save</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fs_fname</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">dump</span>
                        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s1">&#39;Saving (forced) data dump in </span><span class="si">%s</span><span class="s1"> file&#39;</span> <span class="o">%</span> <span class="n">fs_fname</span><span class="p">):</span>
                            <span class="n">vda</span> <span class="o">=</span> <span class="n">get_vda_reader</span><span class="p">(</span><span class="n">fs_fname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                            <span class="n">vda</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;exec mode </span><span class="si">%s</span><span class="s1"> not implemented&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">execute</span><span class="p">)</span>
        <span class="c1"># remove options stuff</span>
        <span class="c1"># GC!</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_io</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;options&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">))</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># asorted helpers</span>

<span class="k">def</span> <span class="nf">get_traced_names</span><span class="p">(</span><span class="n">some_paths</span><span class="p">):</span>
    <span class="c1"># some_paths might me paths of spaths or both</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">((</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">MacroMolPath</span><span class="p">)</span> <span class="k">else</span> <span class="n">sp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">some_paths</span><span class="p">)))))</span>


<span class="c1">################################################################################</span>
<span class="c1"># stages run</span>


<span class="c1"># traceable_residues</span>
<div class="viewcode-block" id="stage_I_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_I_run">[docs]</a><span class="k">def</span> <span class="nf">stage_I_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Loop over frames - search of residues in object:&quot;</span><span class="p">)</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">())</span>

    <span class="c1"># create some containers</span>
    <span class="n">number_frame_rid_in_object</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># res_ids_in_scope_over_frames = {}  # not used</span>
    <span class="n">all_res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># scope will be used to derrive center of system</span>
    <span class="n">center_of_system</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

    <span class="c1"># prepare queues</span>
    <span class="n">pbar_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">results_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">input_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="c1"># prepare and start pool of workers</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stage_I_worker_q</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">input_queue</span><span class="p">,</span> <span class="n">results_queue</span><span class="p">,</span> <span class="n">pbar_queue</span><span class="p">))</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span>
            <span class="n">xrange</span><span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inflate convex hull by </span><span class="si">%0.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">))</span>
    <span class="c1"># feed input_queue with data</span>
    <span class="k">for</span> <span class="n">results_count</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
        <span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">,</span>
                         <span class="n">options</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">()</span> <span class="o">/</span> <span class="mi">500</span><span class="p">)))</span>

    <span class="c1"># display progress</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">progress_target</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pbar_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">progress</span> <span class="o">+=</span> <span class="n">p</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="n">progress_target</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1"># [stop workers]</span>
    <span class="p">[</span><span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1"># collect results</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">((</span><span class="n">results_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Collecting results from layers:&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="n">results_count</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">_all_res</span><span class="p">,</span> <span class="n">_frame_rid_in_object</span><span class="p">,</span> <span class="n">_center_of_system</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">center_of_system</span> <span class="o">+=</span> <span class="n">_center_of_system</span>
        <span class="k">if</span> <span class="n">all_res</span><span class="p">:</span>
            <span class="n">all_res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_all_res</span><span class="p">)</span>
            <span class="n">all_res</span><span class="o">.</span><span class="n">uniquify</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_res</span> <span class="o">=</span> <span class="n">_all_res</span>
        <span class="n">number_frame_rid_in_object</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_frame_rid_in_object</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">center_of_system</span> <span class="o">/=</span> <span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Center of system is </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">center_of_system</span><span class="p">))</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="c1"># join pool</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">all_res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">all_res</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No traceable residues were found.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">add_passing</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Add possible passing paths mols&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">():</span>
                <span class="n">traj_reader</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="n">passing</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">add_passing</span><span class="p">)</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span>
                <span class="n">all_res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">passing</span><span class="p">)</span>
                <span class="n">all_res</span><span class="o">.</span><span class="n">uniquify</span><span class="p">()</span>

    <span class="n">unsandwichize</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">unsandwichize</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Unsandwichize traced residues&quot;</span><span class="p">):</span>
            <span class="c1"># all_res, each layer should comprise of the same res</span>
            <span class="n">all_res_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_res</span><span class="o">.</span><span class="n">ids</span><span class="p">()]))</span>
            <span class="n">all_res</span> <span class="o">=</span> <span class="n">ResidueSelection</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="n">all_res_ids</span><span class="p">})</span>
            <span class="c1"># do similar operation with number_frame_rid_in_object</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">number_frame_rid_in_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of residues to trace: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">all_res</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;all_res&#39;</span><span class="p">:</span> <span class="n">all_res</span><span class="p">,</span>
            <span class="c1"># &#39;res_ids_in_object_over_frames&#39;: res_ids_in_object_over_frames,</span>
            <span class="s1">&#39;number_frame_rid_in_object&#39;</span><span class="p">:</span> <span class="n">number_frame_rid_in_object</span><span class="p">,</span>
            <span class="s1">&#39;center_of_system&#39;</span><span class="p">:</span> <span class="n">center_of_system</span><span class="p">,</span>
            <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()}</span></div>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">number_of_frames</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>  <span class="c1"># number of paths</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frames</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">types</span>
        <span class="n">min_pf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># print &quot;initial&quot;,paths[0].id, (paths[0].min_possible_frame, paths[0].max_possible_frame),(frames[0],frames[-1])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">max_pf</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">number_of_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># min_pf and max_pf are limits of frames</span>
                <span class="n">this_frames</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">this_types</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">min_pf</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">max_pf</span><span class="p">:</span>
                        <span class="n">this_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="n">this_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_frames</span><span class="p">):</span>
                    <span class="c1">#p = GenericPaths(paths[0].id,</span>
                    <span class="c1">#                 name_of_res=paths[0].name,</span>
                    <span class="c1">#                 min_pf=0,</span>
                    <span class="c1">#                 max_pf=number_of_frames-1)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">GenericPaths</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                     <span class="n">name_of_res</span><span class="o">=</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                     <span class="n">min_pf</span><span class="o">=</span><span class="n">min_pf</span><span class="p">,</span>
                                     <span class="n">max_pf</span><span class="o">=</span><span class="n">max_pf</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">update_types_frames</span><span class="p">(</span><span class="n">this_types</span><span class="p">,</span> <span class="n">this_frames</span><span class="p">)</span>
                    <span class="c1"># print p.min_possible_frame,p.max_possible_frame,p.frames[0],p.frames[-1]</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">min_pf</span> <span class="o">=</span> <span class="n">max_pf</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c1"># raw_paths</span>
<div class="viewcode-block" id="stage_II_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_II_run">[docs]</a><span class="k">def</span> <span class="nf">stage_II_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">all_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">number_frame_rid_in_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="c1"># res_ids_in_object_over_frames=None,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># disable real cache of ort</span>
    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1">####################################################################################################################</span>

    <span class="c1"># clear in object info if required</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">clear_in_object_info</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Clear data on residues in object over frames.&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;This will be recalculated on demand.&#39;</span><span class="p">)</span>
        <span class="n">number_frame_rid_in_object</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">is_number_frame_rid_in_object</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">)</span>

    <span class="n">number_of_frames</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Trajectory scan:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>

        <span class="c1"># prepare queues</span>
        <span class="n">pbar_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">results_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">input_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="n">allow_twoway</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_global_options</span><span class="p">()</span><span class="o">.</span><span class="n">twoway</span><span class="p">:</span>
            <span class="n">sI</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sII</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sIII</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># TODO: enable twoway in sandwich mode</span>
            <span class="n">allow_twoway</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sI</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">sII</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">sI</span><span class="o">.</span><span class="n">scope_convexhull</span> <span class="o">==</span> <span class="n">sII</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sI</span><span class="o">.</span><span class="n">object</span> <span class="o">==</span> <span class="n">sII</span><span class="o">.</span><span class="n">object</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                   <span class="n">sIII</span><span class="o">.</span><span class="n">allow_passing_paths</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># prepare and start pool of workers</span>
        <span class="k">if</span> <span class="n">allow_twoway</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Twoway trajectory scan enabled.&#39;</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stage_II_worker_q_twoways</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">input_queue</span><span class="p">,</span> <span class="n">results_queue</span><span class="p">,</span> <span class="n">pbar_queue</span><span class="p">))</span> <span class="k">for</span> <span class="n">dummy</span>
                    <span class="ow">in</span>
                    <span class="n">xrange</span><span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stage_II_worker_q</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">input_queue</span><span class="p">,</span> <span class="n">results_queue</span><span class="p">,</span> <span class="n">pbar_queue</span><span class="p">))</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span>
                    <span class="n">xrange</span><span class="p">(</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inflate convex hull by </span><span class="si">%0.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">))</span>
        <span class="c1"># feed input_queue with data</span>
        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">results_count</span><span class="p">,</span> <span class="p">(</span><span class="n">frame_rid_in_object</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">izip</span><span class="p">(</span><span class="n">iterate_or_die</span><span class="p">(</span><span class="n">number_frame_rid_in_object</span><span class="p">,</span>
                                        <span class="n">times</span><span class="o">=</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()),</span>
                         <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">))):</span>
                <span class="n">all_res_layer</span> <span class="o">=</span> <span class="n">all_res</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

                <span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="n">all_res_layer</span><span class="p">,</span> <span class="n">frame_rid_in_object</span><span class="p">,</span> <span class="n">is_number_frame_rid_in_object</span><span class="p">,</span>
                                 <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_res_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_res</span><span class="o">.</span><span class="n">ids</span><span class="p">()]))</span>
            <span class="n">seek</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">frame_rid_in_object</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">results_count</span><span class="p">,</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
                <span class="n">all_res_layer</span> <span class="o">=</span> <span class="n">ResidueSelection</span><span class="p">({</span><span class="n">number</span><span class="p">:</span> <span class="n">all_res_ids</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">is_number_frame_rid_in_object</span><span class="p">:</span>
                    <span class="n">frame_rid_in_object</span> <span class="o">=</span> <span class="n">number_frame_rid_in_object</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">seek</span><span class="p">:</span><span class="n">seek</span> <span class="o">+</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">len</span><span class="p">()]</span>
                    <span class="n">seek</span> <span class="o">+=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
                <span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">scope_everyframe</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">scope_convexhull_inflate</span><span class="p">,</span>
                                 <span class="n">options</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="n">all_res_layer</span><span class="p">,</span> <span class="n">frame_rid_in_object</span><span class="p">,</span> <span class="n">is_number_frame_rid_in_object</span><span class="p">,</span>
                                 <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)))</span>
            <span class="n">all_res_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_res_layer</span><span class="o">.</span><span class="n">names</span><span class="p">())</span>

        <span class="c1"># display progress</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">progress_target</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">()</span>
        <span class="c1"># progress_target = len(all_res)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pbar_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">progress</span> <span class="o">+=</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="n">progress_target</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">progress</span> <span class="o">%</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># [stop workers]</span>
        <span class="p">[</span><span class="n">input_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>

    <span class="c1"># collect results</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">((</span><span class="n">results_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Collecting results from layers:&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results_queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">rk</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">rk</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong results format; please send bug report.&#39;</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">rk</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="n">rk</span><span class="p">]</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="n">rk</span><span class="p">]})</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="o">==</span> <span class="n">results_count</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">]</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1"># now, results holds 012 matrices, make paths out of it</span>
    <span class="c1"># TODO: Following could be easily written in parallel.</span>

    <span class="n">unsandwichize</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unsandwichize</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_res</span><span class="p">),</span> <span class="s1">&#39;Creating raw paths:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">new_paths</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">all_res_layer</span> <span class="o">=</span> <span class="n">all_res</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

                <span class="n">paths_this_layer</span> <span class="o">=</span> <span class="p">(</span><span class="n">GenericPaths</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span>
                                                 <span class="n">name_of_res</span><span class="o">=</span><span class="n">resname</span><span class="p">,</span>
                                                 <span class="n">min_pf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_pf</span><span class="o">=</span><span class="n">number_of_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">resid</span><span class="p">,</span> <span class="n">resname</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">all_res_layer</span><span class="o">.</span><span class="n">ids</span><span class="p">(),</span>
                                                               <span class="n">all_res_layer</span><span class="o">.</span><span class="n">names</span><span class="p">()))</span>

                <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                <span class="nb">map</span><span class="p">(</span><span class="n">new_paths</span><span class="o">.</span><span class="n">callback_append_next</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">assign_nonsandwiched_paths</span><span class="p">(),</span>
                                                                        <span class="n">izip</span><span class="p">(</span><span class="n">paths_this_layer</span><span class="p">,</span>
                                                                             <span class="n">results_n</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>

                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">unsandwichize</span><span class="p">:</span>
        <span class="c1"># make coherent paths</span>
        <span class="c1"># paths names, paths</span>
        <span class="n">max_pf</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># frames_offset = np.cumsum([0] + frames_offset).tolist()[:len(numbers)]</span>

        <span class="c1"># pbar = clui.pbar(len(results[numbers[0]]), &#39;Sandwich deconvolution:&#39;)</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_res_ids</span><span class="p">),</span> <span class="s1">&#39;Creating raw paths (sandwich deconvolution):&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">new_paths</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>
            <span class="n">pool_func</span> <span class="o">=</span> <span class="n">assign_sandwiched_paths</span><span class="p">(</span><span class="n">all_res_ids</span><span class="p">,</span> <span class="n">all_res_names</span><span class="p">,</span> <span class="n">max_pf</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
            <span class="nb">map</span><span class="p">(</span><span class="n">new_paths</span><span class="o">.</span><span class="n">callback_append_next</span><span class="p">,</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">pool_func</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_res_ids</span><span class="p">))))</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">new_paths</span><span class="o">.</span><span class="n">paths</span>

    <span class="c1"># if edges then split each of path into smaller parts and adjust min_pf and max_pf</span>
    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s1">&#39;Waterfall fall:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>

    <span class="c1"># rm tmp files</span>
    <span class="k">for</span> <span class="n">rn</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_singletons</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span>
                       <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Discard singletons (</span><span class="si">%d</span><span class="s2">) paths:&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_singletons</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">pat</span><span class="o">.</span><span class="n">discard_singletons</span><span class="p">(</span><span class="n">singl</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_singletons</span><span class="p">))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_empty_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Discard residues with empty paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of paths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;all_res&#39;</span><span class="p">:</span> <span class="n">all_res</span><span class="p">,</span> <span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()}</span></div>


<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">spaths_paths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span>


<span class="c1"># separate_paths</span>
<div class="viewcode-block" id="stage_III_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_III_run">[docs]</a><span class="k">def</span> <span class="nf">stage_III_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                  <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>

    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">allow_passing_paths</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Passing paths is a experimental feature. Please, analyze results with care.&quot;</span><span class="p">)</span>

    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_empty_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Discard residues with empty paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1">######################################################################</span>

    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s2">&quot;Create separate paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
        <span class="n">ysp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">yield_single_paths</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">passing</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">allow_passing_paths</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
        <span class="n">spaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nr_all</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sps_nrs</span> <span class="ow">in</span> <span class="n">imap</span><span class="p">(</span><span class="n">ysp</span><span class="p">,</span> <span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">n</span><span class="p">))):</span>
            <span class="c1"># for sps_nrs in pool.imap_unordered(ysp, (paths[i:i + n] for i in xrange(0, len(paths), n))):</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># if no spaths were returned</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">sps_nrs</span><span class="p">:</span>
                <span class="n">spaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nr_all</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nr_all</span> <span class="o">+=</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="s2">&quot;Clean IDs:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">correct_spaths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="si">%d</span><span class="s2"> separate paths out of </span><span class="si">%d</span><span class="s2"> raw paths&quot;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>

    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">remove_unused_parts</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s2">&quot;Removing unused parts of paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">yield_generic_paths</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s1">&#39;Waterfall fall:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>

    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">:</span>
        <span class="c1"># prepare options</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span><span class="p">):</span>
            <span class="n">short_paths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_number</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">):</span>
            <span class="n">short_object</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># check logic</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">short_logic</span> <span class="o">=</span> <span class="n">robust_or</span>  <span class="c1"># for and use or, this is intentional</span>
            <span class="n">short_logic_name</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">short_logic</span> <span class="o">=</span> <span class="n">robust_and</span>
            <span class="n">short_logic_name</span> <span class="o">=</span> <span class="s2">&quot;OR&quot;</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span> <span class="o">!=</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid discard_short_logic &#39;</span><span class="si">%s</span><span class="s2">&#39;, using </span><span class="si">%s</span><span class="s2"> by default.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">options</span><span class="o">.</span><span class="n">discard_short_logic</span><span class="p">,</span> <span class="n">short_logic_name</span><span class="p">))</span>
        <span class="c1"># make message</span>
        <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths shorter than </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> object shorter than </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">short_paths</span><span class="p">,</span> <span class="n">short_logic_name</span><span class="p">,</span> <span class="n">short_object</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths object shorter than </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">short_object</span>
        <span class="k">elif</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">discard_message</span> <span class="o">=</span> <span class="s2">&quot;Discard paths shorter than </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">short_paths</span>
        <span class="c1"># do calculations</span>
        <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="n">discard_message</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">spaths_nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                <span class="n">dse</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">discard_short_etc</span><span class="p">,</span> <span class="n">short_paths</span><span class="o">=</span><span class="n">short_paths</span><span class="p">,</span> <span class="n">short_object</span><span class="o">=</span><span class="n">short_object</span><span class="p">,</span>
                              <span class="n">short_logic</span><span class="o">=</span><span class="n">short_logic</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                <span class="n">new_spaths</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">new_spaths</span><span class="o">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>
                <span class="c1"># CRIC AWARE MP!</span>
                <span class="k">if</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spaths_paths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dse</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">spaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">],),</span>
                                         <span class="n">callback</span><span class="o">=</span><span class="n">new_spaths</span><span class="o">.</span><span class="n">callback_cric_next</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spaths_paths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dse</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">spaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">],),</span>
                                         <span class="n">callback</span><span class="o">=</span><span class="n">new_spaths</span><span class="o">.</span><span class="n">callback_next</span><span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">save_cric</span><span class="p">()</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="n">spaths</span> <span class="o">=</span> <span class="n">new_spaths</span><span class="o">.</span><span class="n">paths</span>
                <span class="k">del</span> <span class="n">new_spaths</span>
            <span class="n">spaths_nr_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spaths_nr</span> <span class="o">==</span> <span class="n">spaths_nr_new</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> paths were discarded.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spaths_nr</span> <span class="o">-</span> <span class="n">spaths_nr_new</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">remove_unused_parts</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s2">&quot;Removing (again) unused parts of paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">paths</span> <span class="o">=</span> <span class="n">yield_generic_paths</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s1">&#39;Waterfall fall:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                            <span class="n">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded - no values were set.&quot;</span><span class="p">)</span>

    <span class="c1">######################################################################</span>

    <span class="n">traced_names</span> <span class="o">=</span> <span class="n">get_traced_names</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">separate_barber</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">[</span><span class="n">tn</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">traced_names</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">:</span>
        <span class="n">new_paths</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># no progress bar (yet)</span>
        <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>  <span class="c1"># tn is a list of traced names</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;AutoBarber calculations for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tn</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">wtc</span> <span class="o">=</span> <span class="n">WhereToCut</span><span class="p">(</span><span class="n">spaths</span><span class="o">=</span><span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tn</span><span class="p">],</span>
                                 <span class="n">selection</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">,</span>
                                 <span class="n">mincut</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_mincut</span><span class="p">,</span>
                                 <span class="n">mincut_level</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_mincut_level</span><span class="p">,</span>
                                 <span class="n">maxcut</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_maxcut</span><span class="p">,</span>
                                 <span class="n">maxcut_level</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_maxcut_level</span><span class="p">,</span>
                                 <span class="n">tovdw</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">auto_barber_tovdw</span><span class="p">)</span>
                <span class="c1"># cut thyself!</span>
                <span class="n">wtc</span><span class="o">.</span><span class="n">cut_thyself</span><span class="p">()</span>  <span class="c1"># wtc for given tn</span>

                <span class="c1"># how many paths of tn we have?</span>
                <span class="n">tnpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr</span> <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tn</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># ids of tn paths, reversed</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wtc</span><span class="o">.</span><span class="n">spheres</span><span class="p">):</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tnpaths</span><span class="p">),</span> <span class="n">n</span><span class="p">)),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;AutoBarber in action:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                        <span class="n">bp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">barber_paths</span><span class="p">,</span> <span class="n">spheres</span><span class="o">=</span><span class="n">wtc</span><span class="o">.</span><span class="n">spheres</span><span class="p">,</span> <span class="n">only_for_names</span><span class="o">=</span><span class="n">tn</span><span class="p">)</span>

                        <span class="n">new_paths</span><span class="o">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>
                        <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">tnpaths</span><span class="p">):</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">([</span><span class="n">paths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tnpaths</span><span class="p">[:</span><span class="n">n</span><span class="p">]],),</span>
                                             <span class="n">callback</span><span class="o">=</span><span class="n">new_paths</span><span class="o">.</span><span class="n">callback_cric_next</span><span class="p">)</span>
                            <span class="n">tnpaths</span> <span class="o">=</span> <span class="n">tnpaths</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
                            <span class="n">nr</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">nr</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;AutoBarber procedure skip, no spheres detected.&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="n">tnpaths</span><span class="p">:</span>
                        <span class="n">new_paths</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
                    <span class="n">tnpaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">new_paths</span><span class="o">.</span><span class="n">paths</span>
        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s1">&#39;Waterfall fall:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>

    <span class="c1">######################################################################</span>
    <span class="c1"># following procedures are run only if autobarber</span>
    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">:</span>

        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Recreate separate paths:&quot;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
        <span class="c1"># ysp = partial(yield_single_paths, progress=True, passing=options.allow_passing_paths)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">/</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># n = max(1, optimal_threads.threads_count)</span>
        <span class="n">spaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nr_all</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sps_nrs</span> <span class="ow">in</span> <span class="n">imap</span><span class="p">(</span><span class="n">ysp</span><span class="p">,</span> <span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">n</span><span class="p">))):</span>
            <span class="c1"># for sps_nrs in pool.imap_unordered(ysp, (paths[i:i + n] for i in xrange(0, len(paths), n))):</span>
            <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">sps_nrs</span><span class="p">:</span>
                <span class="n">spaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nr_all</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nr_all</span> <span class="o">+=</span> <span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="s2">&quot;Clean IDs:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">correct_spaths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>

    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;(Re)Created </span><span class="si">%d</span><span class="s2"> separate paths out of </span><span class="si">%d</span><span class="s2"> raw paths&quot;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>

    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">auto_barber</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_paths</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">discard_short_object</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">short_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="n">discard_message</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="n">spaths_nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                    <span class="c1"># dse = partial(discard_short_etc, short_paths=short_paths, short_object=short_object,</span>
                    <span class="c1">#              short_logic=short_logic)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>
                    <span class="n">new_spaths</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">new_spaths</span><span class="o">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">pbar</span><span class="p">)</span>
                    <span class="c1"># CRIC AWARE MP!</span>
                    <span class="k">if</span> <span class="n">short_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spaths_paths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dse</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">spaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">],),</span>
                                             <span class="n">callback</span><span class="o">=</span><span class="n">new_spaths</span><span class="o">.</span><span class="n">callback_cric_next</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">spaths_paths_ids</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                            <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">dse</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">spaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">],),</span>
                                             <span class="n">callback</span><span class="o">=</span><span class="n">new_spaths</span><span class="o">.</span><span class="n">callback_next</span><span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="n">save_cric</span><span class="p">()</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="n">spaths</span> <span class="o">=</span> <span class="n">new_spaths</span><span class="o">.</span><span class="n">paths</span>
                    <span class="k">del</span> <span class="n">new_spaths</span>
                <span class="c1"># del spaths</span>
                <span class="n">spaths_nr_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spaths_nr</span> <span class="o">==</span> <span class="n">spaths_nr_new</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> paths were discarded.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spaths_nr</span> <span class="o">-</span> <span class="n">spaths_nr_new</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">remove_unused_parts</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s2">&quot;Removing (again) unused parts of paths:&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                            <span class="n">paths</span> <span class="o">=</span> <span class="n">yield_generic_paths</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="s1">&#39;Waterfall fall:&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                                <span class="n">waterfall_me</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">pbar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No paths were discarded - no values were set.&quot;</span><span class="p">)</span>

    <span class="c1">######################################################################</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">sort_by_id</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Sort separate paths by resid&quot;</span><span class="p">):</span>
            <span class="n">spaths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">nr</span><span class="p">))</span>

    <span class="c1">######################################################################</span>

    <span class="c1"># center of object</span>
    <span class="n">coos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">calculate_coo</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="s2">&quot;Center of object calculation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">spaths_nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>
            <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span><span class="p">)</span>

            <span class="c1"># coos = pool.imap_unordered(center_of_object, (spaths[i:i + n] for i in xrange(0, len(spaths), n)))</span>
            <span class="c1"># coos = imap(center_of_object, (sp for sp in spaths if not isinstance(sp,PassingPath)))</span>
            <span class="n">coos</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">center_of_object</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)))</span>

            <span class="c1"># CRIC AWARE MP!</span>
            <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">coos</span> <span class="o">=</span> <span class="p">[</span><span class="n">coo</span> <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">coo</span><span class="p">,</span> <span class="n">cric</span> <span class="ow">in</span> <span class="n">coos</span> <span class="k">if</span> <span class="p">(</span><span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">CRIC</span><span class="o">.</span><span class="n">update_cric</span><span class="p">(</span><span class="n">cric</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)]</span>
            <span class="c1"># coos = list(chain.from_iterable((coo for nr, coo, cric in coos if</span>
            <span class="c1">#                                 (pbar.next(step=nr) is None) and (</span>
            <span class="c1">#                                         CRIC.update_cric(cric) is None))))</span>
            <span class="n">save_cric</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

            <span class="n">coos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coos</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Center of object is </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">, </span><span class="si">%0.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coos</span><span class="p">))</span>

    <span class="c1">######################################################################</span>

    <span class="c1"># apply smoothing?</span>
    <span class="c1"># it is no longer necessary</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">apply_smoothing</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Hard smoothing is not available in the current version but may be available in the future. Stay tuned!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">apply_soft_smoothing</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Soft smoothing option is not available any more. Soft smoothing is enabled by default if --cache-dir or --cache-mem options are used.&quot;</span><span class="p">)</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of paths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of spaths: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span>

    <span class="c1"># return {&#39;paths&#39;: paths, &#39;spaths&#39;: spaths, &#39;options&#39;: options._asdict(), &#39;soptions&#39;: soptions._asdict()}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="n">paths</span><span class="p">,</span> <span class="s1">&#39;spaths&#39;</span><span class="p">:</span> <span class="n">spaths</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span> <span class="s1">&#39;soptions&#39;</span><span class="p">:</span> <span class="n">soptions</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span>
            <span class="s1">&#39;center_of_object&#39;</span><span class="p">:</span> <span class="n">coos</span><span class="p">}</span></div>


<span class="c1">################################################################################</span>


<span class="c1"># inlets_clustering</span>
<div class="viewcode-block" id="stage_IV_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_IV_run">[docs]</a><span class="k">def</span> <span class="nf">stage_IV_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_of_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_of_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># enable real cache of ort</span>
    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="n">coptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cluster_options</span><span class="p">()</span>
    <span class="n">rcoptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_recluster_options</span><span class="p">()</span>
    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>

    <span class="n">max_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">max_level</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">max_level</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="c1"># new style clustering</span>
    <span class="c1"># with clui.fbm(&quot;Create inlets&quot;):</span>
    <span class="c1"># here we can check center of system</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">SimpleProgressBar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Create inlets&quot;</span><span class="p">)</span>
    <span class="n">inlets_center</span> <span class="o">=</span> <span class="n">center_of_system</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_center</span> <span class="o">==</span> <span class="s1">&#39;coo&#39;</span> <span class="ow">and</span> <span class="n">center_of_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inlets_center</span> <span class="o">=</span> <span class="n">center_of_object</span>
    <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_center</span> <span class="o">!=</span> <span class="s1">&#39;cos&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown value of `inlets_center` option </span><span class="si">%r</span><span class="s2">. Falling back to &#39;cos&#39;.&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_center</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_center</span> <span class="o">==</span> <span class="s1">&#39;coo&#39;</span> <span class="ow">and</span> <span class="n">center_of_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Value of &#39;coo&#39; not available. Use `calculate_coo` in stage III. Falling back to &#39;cos&#39;.&quot;</span> <span class="o">%</span> <span class="n">inlets_center</span><span class="p">)</span>
    <span class="n">inls</span> <span class="o">=</span> <span class="n">Inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">center_of_system</span><span class="o">=</span><span class="n">inlets_center</span><span class="p">,</span>
                  <span class="n">passing</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">exclude_passing_in_clustering</span><span class="p">,</span>
                  <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Number of inlets: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">inls</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">noo</span><span class="p">():</span>
        <span class="c1"># returns number of outliers</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">clustering_clustering</span><span class="p">():</span>
        <span class="c1"># ***** CLUSTERING *****</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Performing clustering&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">potentially_recursive_clustering</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                             <span class="n">clustering_name</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">(),</span>
                                             <span class="n">inlets_object</span><span class="o">=</span><span class="n">inls</span><span class="p">,</span>
                                             <span class="n">spaths</span><span class="o">=</span><span class="n">spaths</span><span class="p">,</span>
                                             <span class="n">message</span><span class="o">=</span><span class="s1">&#39;clustering&#39;</span><span class="p">,</span>
                                             <span class="n">max_level</span><span class="o">=</span><span class="n">max_level</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">outliers_detection</span><span class="p">():</span>
        <span class="c1"># ***** OUTLIERS DETECTION *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Detecting outliers&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Auto</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span>
                <span class="n">no_out_detected</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">std</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">,</span>
                                                <span class="n">inls</span><span class="o">.</span><span class="n">clusters_centers</span><span class="p">,</span>
                                                <span class="n">inls</span><span class="o">.</span><span class="n">clusters_std</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
                    <span class="n">dmat</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">center</span><span class="p">),</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="c1"># Auto procedure</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">detect_outliers</span> <span class="ow">is</span> <span class="n">Auto</span><span class="p">:</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># FIXME: magic constant!</span>
                    <span class="c1"># defined threshold procedure</span>
                    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">inlets_ids</span><span class="p">)):</span>
                        <span class="c1"># print d, threshold</span>
                        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                            <span class="n">clusters</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">no_out_detected</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Detected </span><span class="si">%d</span><span class="s1"> outliers.&#39;</span> <span class="o">%</span> <span class="n">no_out_detected</span><span class="p">)</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">add_outliers_annotations</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">reclustering</span><span class="p">():</span>
        <span class="c1"># ***** RECLUSTERING *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">recluster_outliers</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Performing reclustering of outliers&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">clustering_function</span> <span class="o">=</span> <span class="n">get_clustering_method</span><span class="p">(</span><span class="n">rcoptions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="c1"># perform reclustering</span>
                <span class="c1"># inls.recluster_outliers(clustering_function)</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">recluster_cluster</span><span class="p">(</span><span class="n">clustering_function</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">singletons_removal</span><span class="p">():</span>
        <span class="c1"># ***** SINGLETONS REMOVAL *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Removing clusters of size </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">)):</span>
                    <span class="n">inls</span><span class="o">.</span><span class="n">small_clusters_to_outliers</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">singletons_outliers</span><span class="p">))</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of clusters detected so far: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">))</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Number of outliers: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">noo</span><span class="p">())</span>

        <span class="c1"># TODO: Move it after master paths!</span>

    <span class="k">def</span> <span class="nf">add_passing_paths_to_clusters</span><span class="p">():</span>
        <span class="c1"># ***** ADD PASSING PATHS TO CLUSTERS *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">exclude_passing_in_clustering</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">add_passing_to_clusters</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Adding passing paths inlets to clusters&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="c1"># passing paths were excluded and they are meant to be added</span>
                <span class="c1"># one need loop over clusters and then all passing paths have to checked</span>
                <span class="c1"># it is assumed taht adding method is barber</span>
                <span class="n">abo</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_stage_options</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># ab from stage III</span>
                <span class="n">ab_options</span> <span class="o">=</span> <span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">abo</span><span class="p">)</span>
                <span class="n">ab_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_auto_barber_options</span><span class="p">(</span><span class="n">options</span><span class="p">))</span>
                <span class="c1"># get single paths only (no passing paths)</span>
                <span class="n">spaths_single</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">is_single</span><span class="p">()]</span>
                <span class="c1"># ids of passing paths</span>
                <span class="n">spaths_passing_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span> <span class="k">if</span> <span class="n">spaths</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span><span class="o">.</span><span class="n">is_passing</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_passing_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No passing paths to add.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># loop over passing paths, add to inlets</span>
                    <span class="n">inls</span><span class="o">.</span><span class="n">passing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">passing_inlets_ids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">passing_id</span> <span class="ow">in</span> <span class="n">spaths_passing_ids</span><span class="p">:</span>
                        <span class="n">passing_inlets_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">extend_inlets</span><span class="p">(</span><span class="n">spaths</span><span class="p">[</span><span class="n">passing_id</span><span class="p">]))</span>
                    <span class="c1"># loop over clusters</span>
                    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
                        <span class="n">added_to_cluster</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Current cluster: </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cluster</span><span class="p">)</span>
                        <span class="c1"># sps = inls.lim2clusters(cluster).limspaths2(spaths_single)</span>
                        <span class="c1"># chull = inls.lim2clusters(cluster).get_chull()</span>
                        <span class="n">wtc</span> <span class="o">=</span> <span class="n">WhereToCut</span><span class="p">(</span><span class="n">inlets</span><span class="o">=</span><span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">cluster</span><span class="p">),</span> <span class="o">**</span><span class="n">ab_options</span><span class="p">)</span>
                        <span class="n">wtc</span><span class="o">.</span><span class="n">cut_thyself</span><span class="p">()</span>
                        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">SimpleProgressBar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">),</span>
                                                      <span class="s2">&quot;Loop over available passing paths inlets:&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">passing_inlet_nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">inlet</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">inlets_list</span><span class="p">[</span><span class="n">passing_inlets_ids</span><span class="p">[</span><span class="n">passing_inlet_nr</span><span class="p">]]</span>
                            <span class="n">sphere</span> <span class="o">=</span> <span class="n">wtc</span><span class="o">.</span><span class="n">inlet2sphere</span><span class="p">(</span><span class="n">inlet</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sphere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># if True:</span>
                                <span class="k">if</span> <span class="n">wtc</span><span class="o">.</span><span class="n">is_overlaping_with_cloud</span><span class="p">(</span><span class="n">sphere</span><span class="p">):</span>
                                    <span class="c1"># if chull.point_within(inlet.coords):</span>
                                    <span class="c1"># add this inlet to cluster!</span>
                                    <span class="n">inls</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">passing_inlets_ids</span><span class="p">[</span><span class="n">passing_inlet_nr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cluster</span>
                                    <span class="n">added_to_cluster</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">passing_inlets_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">passing_inlet_nr</span><span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">added_to_cluster</span><span class="p">:</span>
                            <span class="n">inls</span><span class="o">.</span><span class="n">add_message_wrapper</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;+</span><span class="si">%d</span><span class="s1"> passing&#39;</span> <span class="o">%</span> <span class="n">added_to_cluster</span><span class="p">,</span> <span class="n">toleaf</span><span class="o">=</span><span class="n">cluster</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">):</span>
                        <span class="n">inls</span><span class="o">.</span><span class="n">add_message_wrapper</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;+</span><span class="si">%d</span><span class="s1"> passing&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">passing_inlets_ids</span><span class="p">),</span> <span class="n">toleaf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">join_clusters</span><span class="p">():</span>
        <span class="c1"># ***** JOIN CLUSTERS *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">join_clusters</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Join clusters&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">emess</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2j</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">join_clusters</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">emess</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c2j</span><span class="p">)</span>
                    <span class="n">c2j</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c2j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">))</span>
                    <span class="n">inls</span><span class="o">.</span><span class="n">join_clusters</span><span class="p">(</span><span class="n">c2j</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">renumber_clusters</span><span class="p">():</span>
        <span class="c1"># ***** RENUMBER CLUSTERS *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">renumber_clusters</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Renumber clusters&quot;</span><span class="p">):</span>
                <span class="n">inls</span><span class="o">.</span><span class="n">renumber_clusters</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove_inlets_in_specified_clusters</span><span class="p">():</span>
        <span class="c1"># ***** REMOVE INLETS IN SPECIFIED CLUSTERS *****</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">remove_inlets</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Remove inlets&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">emess</span><span class="p">:</span>
                <span class="n">inlets_removed_reference</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">inlets_removed_type</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i2r</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">remove_inlets</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>  <span class="c1"># i2r is cluster id</span>
                    <span class="n">emess</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i2r</span><span class="p">)</span>
                    <span class="n">inlets_removed_reference</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">i2r</span><span class="p">)</span><span class="o">.</span><span class="n">refs</span><span class="p">)</span>
                    <span class="n">inlets_removed_type</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">i2r</span><span class="p">)</span><span class="o">.</span><span class="n">types</span><span class="p">)</span>
                    <span class="n">inls</span><span class="o">.</span><span class="n">remove_inlets</span><span class="p">(</span><span class="n">i2r</span><span class="p">)</span>
                <span class="c1"># clusters removed, modify spaths</span>
                <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inlets_removed_reference</span><span class="p">,</span> <span class="n">inlets_removed_type</span><span class="p">):</span>
                    <span class="c1"># find path of r</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">r</span><span class="p">))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">remove_inlet</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inls</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">clustering_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">clustering_clustering</span><span class="p">,</span> <span class="n">reclustering</span><span class="p">,</span> <span class="n">singletons_removal</span><span class="p">,</span> <span class="n">add_passing_paths_to_clusters</span><span class="p">,</span>
                            <span class="n">join_clusters</span><span class="p">,</span> <span class="n">renumber_clusters</span><span class="p">,</span> <span class="n">remove_inlets_in_specified_clusters</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">clustering_order</span> <span class="o">==</span> <span class="s2">&quot;aquarius&quot;</span><span class="p">:</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Age of Aquarius.&quot;</span><span class="p">)</span>
            <span class="n">clustering_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">clustering_clustering</span><span class="p">,</span> <span class="n">join_clusters</span><span class="p">,</span> <span class="n">renumber_clusters</span><span class="p">,</span> <span class="n">outliers_detection</span><span class="p">,</span>
                                <span class="n">reclustering</span><span class="p">,</span> <span class="n">singletons_removal</span><span class="p">,</span> <span class="n">add_passing_paths_to_clusters</span><span class="p">,</span>
                                <span class="n">remove_inlets_in_specified_clusters</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">clustering_order</span> <span class="o">!=</span> <span class="s2">&quot;old-school&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">waring</span><span class="p">(</span><span class="s2">&quot;Unknown clustering order mode &#39;</span><span class="si">%s</span><span class="s2">&#39;, falling back to &#39;old-school&#39;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cluster_function</span> <span class="ow">in</span> <span class="n">clustering_order</span><span class="p">:</span>
            <span class="n">cluster_function</span><span class="p">()</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1">###################</span>
        <span class="c1"># CLUSTERING DONE #</span>
        <span class="c1">###################</span>

        <span class="c1"># ***** CLUSTERS&#39; HISTORY *****</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Clustering history:&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">print_simple_tree</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="n">traced_names</span> <span class="o">=</span> <span class="n">get_traced_names</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">separate_master</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">[</span><span class="n">tn</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">separate_master_all</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">traced_names</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">traced_names</span>

        <span class="c1"># but only if user wants this</span>
        <span class="n">master_paths</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># this and following dict hold master paths, keys here ar ctypes - one ctype one master path</span>
        <span class="n">master_paths_smooth</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">create_master_paths</span><span class="p">:</span>
            <span class="n">fof</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="n">make_fractionof</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">master_paths_amount</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>  <span class="c1"># tn is a list of traced names</span>
                <span class="c1"># here we can select which paths are to be used</span>
                <span class="n">mpsps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span>
                         <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tn</span><span class="p">]</span>  <span class="c1"># no PassingPaths, tn only</span>
                <span class="c1"># sort by size to ger stratification like effect</span>
                <span class="n">mpsps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">mpsps</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">ctypes</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">spaths2ctypes</span><span class="p">(</span><span class="n">mpsps</span><span class="p">)</span>  <span class="c1"># temp ctypes</span>
                <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Master paths calculations for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tn</span><span class="p">)),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="n">get_smooth_method</span><span class="p">(</span><span class="n">soptions</span><span class="p">)</span>  <span class="c1"># this have to preceed GCS</span>
                    <span class="k">if</span> <span class="n">GCS</span><span class="o">.</span><span class="n">cachedir</span> <span class="ow">or</span> <span class="n">GCS</span><span class="o">.</span><span class="n">cachemem</span><span class="p">:</span>
                        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mpsps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Building coords cache&#39;</span><span class="p">)</span>  <span class="c1"># +2 to be on the safe side</span>
                        <span class="c1"># TODO: do it in parallel</span>
                        <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">mpsps</span> <span class="k">if</span>
                         <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)]</span>
                        <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">get_coords</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">mpsps</span> <span class="k">if</span>
                         <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">)]</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                        <span class="n">use_threads</span> <span class="o">=</span> <span class="n">optimal_threads</span><span class="o">.</span><span class="n">threads_count</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Master paths calculation without cache-dir or cache-mem option can be EXTREMELY slow.&quot;</span><span class="p">)</span>
                        <span class="n">use_threads</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Creating master paths for cluster types&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
                        <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

                        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mpsps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">))</span>
                            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">mpsps</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">), no single paths found, MasterPath calculation skipped.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">,))</span>
                                <span class="k">continue</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;CType </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">), number of spaths </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">nr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)))</span>
                            <span class="n">ctspc</span> <span class="o">=</span> <span class="n">CTypeSpathsCollection</span><span class="p">(</span><span class="n">spaths</span><span class="o">=</span><span class="n">sps</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">ct</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">,</span>
                                                          <span class="n">threads</span><span class="o">=</span><span class="n">use_threads</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">traced_names</span><span class="p">:</span>  <span class="c1"># either no separate or all option</span>
                                <span class="n">master_paths</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">))})</span>
                                <span class="n">master_paths_smooth</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)})</span>
                            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># tn is one name</span>
                                <span class="k">if</span> <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">:</span>
                                    <span class="n">master_paths</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{}})</span>
                                <span class="k">if</span> <span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="p">:</span>
                                    <span class="n">master_paths_smooth</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{}})</span>
                                <span class="n">master_paths</span><span class="p">[</span><span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">))})</span>
                                <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">tn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                    <span class="p">{</span><span class="n">ct</span><span class="p">:</span> <span class="n">ctspc</span><span class="o">.</span><span class="n">get_master_path</span><span class="p">(</span><span class="n">resid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nr</span><span class="p">),</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                                    <span class="s2">&quot;Internal bug, not consistent iteration over traced names. Please send bug report to &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">__mail__</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">ctspc</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;No inlets found. Clustering skipped.&quot;</span><span class="p">)</span>
        <span class="c1"># make empty results</span>
        <span class="n">master_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">master_paths_smooth</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ***** CLUSTERS&#39; TYPES *****</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Calculating cluster types&quot;</span><span class="p">):</span>
        <span class="n">ctypes</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">spaths2ctypes</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

    <span class="c1">################################################################################</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;inls&#39;</span><span class="p">:</span> <span class="n">inls</span><span class="p">,</span>
            <span class="s1">&#39;ctypes&#39;</span><span class="p">:</span> <span class="n">ctypes</span><span class="p">,</span>
            <span class="s1">&#39;master_paths&#39;</span><span class="p">:</span> <span class="n">master_paths</span><span class="p">,</span>
            <span class="s1">&#39;master_paths_smooth&#39;</span><span class="p">:</span> <span class="n">master_paths_smooth</span><span class="p">,</span>
            <span class="s1">&#39;spaths&#39;</span><span class="p">:</span> <span class="n">spaths</span><span class="p">}</span></div>


<span class="c1">################################################################################</span>

<span class="c1"># analysis</span>
<div class="viewcode-block" id="stage_V_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_V_run">[docs]</a><span class="k">def</span> <span class="nf">stage_V_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">inls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">ctypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># enable real cache of ort</span>
    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># file handle?</span>
    <span class="n">head_nr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">line_nr</span> <span class="o">=</span> <span class="n">head_nr</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">PrintAnalysis</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">line_nr</span><span class="o">=</span><span class="n">line_nr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Using user provided file (</span><span class="si">%s</span><span class="s1">), and&#39;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;for histograms data file (</span><span class="si">%s</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">))</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Using standard output.&#39;</span><span class="p">)</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sep</span><span class="p">())</span>
        <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;Aqua-Duct analysis&#39;</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">get_str_timestamp</span><span class="p">())</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;Aqua-Duct: v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">aquaduct_version_nice</span><span class="p">())</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;NumPy: v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;MDAnalysis: v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mda_ver</span><span class="p">())</span>

    <span class="c1">############</span>
    <span class="c1"># format for path ID</span>
    <span class="n">max_ID_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">max_ID_len</span><span class="p">:</span>
            <span class="n">max_ID_len</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">spath_id_header</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%%d</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_ID_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dump_config</span><span class="p">:</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">under</span><span class="p">(</span><span class="s1">&#39;Configuration file name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dump_config</span><span class="p">()))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Frames window: </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2"> step </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                         <span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                                         <span class="n">Reader</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>

    <span class="c1">############</span>
    <span class="n">traced_names</span> <span class="o">=</span> <span class="n">get_traced_names</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Names of traced molecules: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)))</span>

    <span class="c1"># spaths_types = [&#39;all&#39;]</span>
    <span class="n">spaths_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">PassingPath</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="n">spaths_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PassingPath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">SinglePath</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="n">spaths_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SinglePath</span><span class="p">)</span>
    <span class="n">spaths_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span>

    <span class="c1">############</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">traced_names</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># all types</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_tname</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_tname</span><span class="p">,),</span> <span class="s2">&quot; of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_tname</span>

    <span class="k">def</span> <span class="nf">iter_over_tnspt</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_message</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">spaths_types</span><span class="p">,</span> <span class="n">_message</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_sptype</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">PassingPath</span><span class="p">:</span>
                        <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;passing paths&#39;</span>
                    <span class="k">elif</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">SinglePath</span><span class="p">:</span>
                        <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;object  paths&#39;</span>
                    <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="p">(</span><span class="n">_sptype</span><span class="p">,),</span> <span class="n">_message</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_sptype_name</span><span class="p">)</span>

    <span class="c1">############</span>

    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="c1"># calculate number of tnspt</span>
        <span class="n">nr_tnspt</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr</span> <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iter_over_tnspt</span><span class="p">())][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">nr_f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">nr_tnspt</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">nr_f</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span> <span class="n">mess</span><span class="o">=</span><span class="s2">&quot;Calculating stats:&quot;</span><span class="p">)</span>

    <span class="c1">############</span>

    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of traceable residues</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
           <span class="p">(</span><span class="n">message</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of separate paths</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
           <span class="p">(</span><span class="n">message</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">))])))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of inlets</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="n">no_of_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="mi">0</span><span class="p">}[</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">]</span>  <span class="c1"># minus outliers, if any</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Number of clusters: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">no_of_clusters</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Outliers: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;no&#39;</span><span class="p">}[</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">]))</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s1">&#39;Clustering history:&#39;</span><span class="p">)</span>
    <span class="n">pa</span><span class="p">(</span><span class="n">clui</span><span class="o">.</span><span class="n">print_simple_tree</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_inlets_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters summary - inlets</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span>
                <span class="n">cl</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_inlets</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">inls_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters summary - inlets</span><span class="si">%s</span><span class="s2"> for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
                    <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">])</span><span class="o">.</span> \
                        <span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span> \
                        <span class="n">lim2clusters</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
                    <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_inlets</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">inls_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="c1">############</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cluster_area</span><span class="p">:</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_area_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
            <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters summary - areas</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>

                <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span>
                    <span class="n">tname</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span>
                    <span class="n">cl</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_area</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">inls_lim</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_precision</span><span class="p">),</span>
                                                          <span class="n">expand_by</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_expand</span><span class="p">))),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters summary - areas</span><span class="si">%s</span><span class="s2"> for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                    <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>

                        <span class="n">inls_lim</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2spaths</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">])</span><span class="o">.</span> \
                            <span class="n">lim2rnames</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span><span class="o">.</span> \
                            <span class="n">lim2clusters</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">inls_lim</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span>
                                     <span class="n">clusters_area</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">inls_lim</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_precision</span><span class="p">),</span>
                                                   <span class="n">expand_by</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_expand</span><span class="p">))),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="c1">############</span>
    <span class="c1">############</span>
    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_prob_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) probabilities of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_prob</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_len_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean lengths of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_len</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_steps_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean frames numbers of transfers&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
            <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                         <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_steps</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_prob_header</span><span class="p">(),</span>
                                                                               <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) probabilities of transfers for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
                    <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                                 <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
                    <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_prob</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

                <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_len_header</span><span class="p">(),</span>
                                                                               <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean lengths of transfers for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
                    <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                                 <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
                    <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_len</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

                <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">clusters_stats_steps_header</span><span class="p">(),</span>
                                                                               <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Clusters statistics (of paths</span><span class="si">%s</span><span class="s2">) mean frames numbers of transfers for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">):</span>
                    <span class="n">sp_ct_lim</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">)</span> <span class="k">if</span>
                                 <span class="n">cl</span> <span class="ow">in</span> <span class="n">ct</span><span class="o">.</span><span class="n">clusters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">)</span>
                    <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">clusters_stats_steps</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">sp_ct_lim</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">ctypes_spaths_info_header</span><span class="p">(),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>

    <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

    <span class="c1"># sorted by ctype</span>
    <span class="n">ctypes_size</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
        <span class="n">ctypes_size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes_generic_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ctypes_size</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">iter_over_tnspt</span><span class="p">():</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean lengths of paths</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
            <span class="c1"># ctypes_size.append(len(sps))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;len&quot;</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean number of frames of paths</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
            <span class="c1"># ctypes_size.append(len(sps))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;frames&quot;</span><span class="p">)),</span>
                   <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean lengths of paths</span><span class="si">%s</span><span class="s2"> for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

                <span class="n">total_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                    <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                    <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
                    <span class="c1"># ctypes_size.append(len(sps))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;len&quot;</span><span class="p">)),</span>
                           <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;Separate paths clusters types summary - mean number of frames of paths</span><span class="si">%s</span><span class="s2"> for layer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">message</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                    <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                    <span class="n">sps</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">)]</span>
                    <span class="c1"># ctypes_size.append(len(sps))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span>
                                     <span class="n">ctypes_spaths_info</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">add_size_p100</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="s2">&quot;frames&quot;</span><span class="p">)),</span>
                           <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sps</span><span class="p">))</span>

        <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="c1">############</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">sep</span><span class="p">()</span>
    <span class="n">pa</span><span class="p">(</span><span class="s2">&quot;List of separate paths and properties&quot;</span><span class="p">)</span>
    <span class="n">header_line</span><span class="p">,</span> <span class="n">line_template</span> <span class="o">=</span> <span class="n">get_header_line_and_line_template</span><span class="p">(</span><span class="n">spath_full_info_header</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">head_nr</span><span class="o">=</span><span class="n">head_nr</span><span class="p">)</span>
    <span class="n">pa</span><span class="o">.</span><span class="n">thead</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ctype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip_longest</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">ctype</span><span class="o">.</span><span class="n">generic</span>
        <span class="n">pa</span><span class="p">(</span><span class="n">make_line</span><span class="p">(</span><span class="n">line_template</span><span class="p">,</span> <span class="n">spath_full_info</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="n">ctype</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

    <span class="n">pa</span><span class="o">.</span><span class="n">tend</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="c1">############</span>
    <span class="c1"># additional analysis</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="c1"># this fuction is redefined here because of changed messages</span>
        <span class="k">yield</span> <span class="n">traced_names</span><span class="p">,</span> <span class="s1">&#39;amol&#39;</span>  <span class="c1"># all types</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traced_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_tname</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_tname</span><span class="p">,),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_tname</span>

    <span class="k">def</span> <span class="nf">iter_over_part</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_part</span> <span class="ow">in</span> <span class="s1">&#39;walk in object out&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;in out&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_part</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_message</span> <span class="o">=</span> <span class="n">_part</span>
                <span class="n">_part</span> <span class="o">=</span> <span class="p">[</span><span class="n">_part</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>

    <span class="k">def</span> <span class="nf">iter_over_spt</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">spaths_types</span><span class="p">,</span> <span class="s1">&#39;apaths&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spaths_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_sptype</span> <span class="ow">in</span> <span class="n">spaths_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">PassingPath</span><span class="p">:</span>
                    <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;passing&#39;</span>
                <span class="k">elif</span> <span class="n">_sptype</span> <span class="o">==</span> <span class="n">SinglePath</span><span class="p">:</span>
                    <span class="n">_sptype_name</span> <span class="o">=</span> <span class="s1">&#39;object&#39;</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_sptype</span><span class="p">,),</span> <span class="n">_sptype_name</span>

    <span class="k">def</span> <span class="nf">iter_over_c</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="s1">&#39;aclusts&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_cluster</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="p">[</span><span class="n">_cluster</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">_cluster</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_ct</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">ctypes_generic_list</span><span class="p">,</span> <span class="s1">&#39;actypes&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_cluster</span> <span class="ow">in</span> <span class="n">ctypes_generic_list</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">_cluster</span><span class="p">,),</span> <span class="nb">str</span><span class="p">(</span><span class="n">_cluster</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_all</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_m_tname</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_m_sptype</span> <span class="ow">in</span> <span class="n">iter_over_spt</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">_cluster</span><span class="p">,</span> <span class="n">_m_cluster</span> <span class="ow">in</span> <span class="n">iter_over_c</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_m_part</span> <span class="ow">in</span> <span class="n">iter_over_part</span><span class="p">():</span>
                        <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">_m_tname</span><span class="p">,</span>
                                             <span class="n">_m_sptype</span><span class="p">,</span>
                                             <span class="n">_m_cluster</span><span class="p">,</span>
                                             <span class="n">_m_part</span><span class="p">))</span>
                        <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_cluster</span><span class="p">,</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>
                <span class="k">for</span> <span class="n">_ctype</span><span class="p">,</span> <span class="n">_m_ctype</span> <span class="ow">in</span> <span class="n">iter_over_ct</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_m_part</span> <span class="ow">in</span> <span class="n">iter_over_part</span><span class="p">():</span>
                        <span class="n">_message</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">_m_tname</span><span class="p">,</span>
                                             <span class="n">_m_sptype</span><span class="p">,</span>
                                             <span class="n">_m_ctype</span><span class="p">,</span>
                                             <span class="n">_m_part</span><span class="p">))</span>
                        <span class="k">yield</span> <span class="n">_tname</span><span class="p">,</span> <span class="n">_sptype</span><span class="p">,</span> <span class="n">_ctype</span><span class="p">,</span> <span class="n">_part</span><span class="p">,</span> <span class="n">_message</span>

    <span class="c1"># histograms</span>
    <span class="c1"># calculate old max_frame</span>
    <span class="n">max_frame</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(</span><span class="n">onelayer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">iter_over_all</span><span class="p">()]</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_frame</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
    <span class="c1"># loop over spaths</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">),</span>
                     <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Calculating histograms:&#39;</span><span class="p">)</span>
    <span class="c1"># loop over paths and ctypes</span>
    <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">ctypes</span><span class="p">):</span>
        <span class="c1"># loop over columns</span>
        <span class="c1"># traced names, paths types, clusters cluster types, part of paths, column name</span>
        <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">sptype</span><span class="p">,</span> <span class="n">c_ct</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">iter_over_all</span><span class="p">():</span>
            <span class="c1"># check if column fits to the requirements</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">tname</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sptype</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># c or ct</span>
            <span class="n">it_is_ct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">InletClusterGenericType</span><span class="p">):</span>
                <span class="n">it_is_ct</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_full</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span> <span class="n">c_ct</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># this is more than that...</span>
            <span class="c1"># if c_ct is not InletClusterGenericType then:</span>
            <span class="c1"># if &#39;in&#39; in part only incoming paths in ct are used</span>
            <span class="c1"># if &#39;out&#39; in part only outgoing paths in ct are used</span>
            <span class="n">col_index</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;walk&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">paths_cont</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">PassingPath</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;in&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">it_is_ct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">input</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_in</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;object&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_object</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;out&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">it_is_ct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ct</span><span class="o">.</span><span class="n">output</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">h</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">path_out</span><span class="p">,</span> <span class="n">col_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">scope_chull_inflate</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inflate convex hull by </span><span class="si">%0.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope_chull_inflate</span><span class="p">))</span>

    <span class="c1"># scope/object size?</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">calculate_scope_object_size</span><span class="p">:</span>
        <span class="n">scope_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">object_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># now, the problem is in the scope and object definition.</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="n">maxval</span><span class="o">=</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_frames</span><span class="p">(),</span> <span class="n">mess</span><span class="o">=</span><span class="s1">&#39;Calculating scope and object sizes&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">traj_reader</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">number</span><span class="p">),</span>
                              <span class="p">[</span><span class="s1">&#39;scope_area&#39;</span><span class="p">,</span> <span class="s1">&#39;scope_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;object_area&#39;</span><span class="p">,</span> <span class="s1">&#39;object_volume&#39;</span><span class="p">])</span>
                <span class="n">fmt</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">scope_size</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">,</span>
                              <span class="p">[</span><span class="s1">&#39;scope_area&#39;</span><span class="p">,</span> <span class="s1">&#39;scope_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;object_area&#39;</span><span class="p">,</span> <span class="s1">&#39;object_volume&#39;</span><span class="p">])</span>
                <span class="n">fmt</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">scope_size</span><span class="p">):</span>
                <span class="n">scope_size</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">object_size</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">iterate_over_frames</span><span class="p">():</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">scope_chull</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">chull</span><span class="p">(</span><span class="n">inflate</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">scope_chull_inflate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scope_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot get Convex Hull for Scope in </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
                    <span class="n">scope_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">object_chull</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">object_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ch</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">ch</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot get Convex Hull for Object in </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
                    <span class="n">object_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)))</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s_s</span><span class="p">,</span> <span class="n">o_s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scope_size</span><span class="p">,</span> <span class="n">object_size</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">s_s</span><span class="p">,</span> <span class="n">o_s</span><span class="p">))</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="c1"># add frame column?</span>
    <span class="n">frame_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">max_frame</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">frame_col</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fmt</span>
    <span class="c1"># save???</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="n">h_fname</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">cStringIO</span> <span class="k">as</span> <span class="nn">StringIO</span>
        <span class="n">h_fname</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">h_fname</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span>
               <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span>
               <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
               <span class="n">header</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
        <span class="n">h_fname</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="c1"># print h_fname.getvalue()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">}</span></div>


<span class="c1">################################################################################</span>

<span class="c1"># visualize</span>


<div class="viewcode-block" id="stage_VI_run"><a class="viewcode-back" href="../../../../aquaduct.apps.valve.core.html#aquaduct.apps.valve.core.stage_VI_run">[docs]</a><span class="k">def</span> <span class="nf">stage_VI_run</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
                 <span class="n">spaths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">inls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ctypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">master_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">master_paths_smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_of_system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">center_of_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># enable real cache of ort</span>
    <span class="n">Reader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">aquaduct.visual.pymol_connector</span> <span class="k">import</span> <span class="n">ConnectToPymol</span><span class="p">,</span> <span class="n">SinglePathPlotter</span>
    <span class="c1"># from aquaduct.visual.pymol_connector import cmd as pymol_cmd</span>
    <span class="kn">from</span> <span class="nn">aquaduct.visual.helpers</span> <span class="k">import</span> <span class="n">ColorMapDistMap</span>

    <span class="n">soptions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_smooth_options</span><span class="p">()</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="n">get_smooth_method</span><span class="p">(</span><span class="n">soptions</span><span class="p">)</span>

    <span class="n">traced_names</span> <span class="o">=</span> <span class="n">get_traced_names</span><span class="p">(</span><span class="n">spaths</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iter_over_tn</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">split_by_type</span><span class="p">:</span>
            <span class="k">yield</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">retain_all_types</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">traced_names</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>

    <span class="c1"># start pymol</span>
    <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Starting PyMOL connection&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">pymol_connector</span> <span class="o">=</span> <span class="n">ConnectToPymol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_pymol_connector_script</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">init_script</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">init_pymol</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">simply_smooths</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">SinglePathPlotter</span><span class="p">(</span><span class="n">pymol_connector</span><span class="p">,</span> <span class="n">linearize</span><span class="o">=</span><span class="n">get_linearize_method</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">simply_smooths</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spp</span> <span class="o">=</span> <span class="n">SinglePathPlotter</span><span class="p">(</span><span class="n">pymol_connector</span><span class="p">,</span> <span class="n">linearize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">ctypes_generic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">generic</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ctypes</span><span class="p">]</span>
    <span class="n">ctypes_generic_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">:</span>
        <span class="n">molecule_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Molecule&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
                <span class="n">traj_reader</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="c1"># mda_ppr = mda.core.flags[&quot;permissive_pdb_reader&quot;]</span>
                <span class="c1"># mda.core.flags[&quot;permissive_pdb_reader&quot;] = False #mda16 it is porbably always True</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_molecule_frames</span><span class="p">)</span>
                <span class="n">pdbfile</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">dump_frames</span><span class="p">(</span><span class="n">frames_to_show</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">)</span>
                <span class="n">pymol_connector</span><span class="o">.</span><span class="n">load_pdb</span><span class="p">(</span><span class="s1">&#39;molecule</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">pdbfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">molecule_name</span> <span class="o">=</span> <span class="s1">&#39;molecule</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>
                <span class="c1"># it would be nice to plot convexhull</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Convexhull&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_inflate</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inflate convex hull by </span><span class="si">%0.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_inflate</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
                <span class="n">traj_reader</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_frames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_show</span><span class="p">:</span>
                    <span class="n">traj_reader</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">scope</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull</span><span class="p">)</span>
                    <span class="n">chull</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">chull</span><span class="p">(</span><span class="n">inflate</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">show_scope_chull_inflate</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">convexhull</span><span class="p">(</span><span class="n">chull</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;scope_shape</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Scope convex hull calculations failed for frame </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_object_chull</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Object shape&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">traj_reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
                <span class="n">traj_reader</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="n">frames_to_show</span> <span class="o">=</span> <span class="n">range2int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_object_chull_frames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_show</span><span class="p">:</span>
                    <span class="n">traj_reader</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">object_shape</span> <span class="o">=</span> <span class="n">traj_reader</span><span class="o">.</span><span class="n">parse_selection</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">show_object_chull</span><span class="p">)</span>
                    <span class="n">chull</span> <span class="o">=</span> <span class="n">object_shape</span><span class="o">.</span><span class="n">chull</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">chull</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">convexhull</span><span class="p">(</span><span class="n">chull</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;object_shape</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">,</span>
                                       <span class="n">state</span><span class="o">=</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># orange</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Object convex hull calculations failed for frame </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>

    <span class="n">fof</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">make_fractionof</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">inlets_clusters_amount</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">inlets_clusters</span><span class="p">:</span>
        <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">inls</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2rnames</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Clusters&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">tn_name</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
                <span class="c1"># TODO: require stage V for that?</span>
                <span class="c1"># no_of_clusters = len(inls.clusters_list)  # total, including outliers</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">ColorMapDistMap</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                            <span class="c1"># coords for current cluster and layer</span>
                            <span class="n">ics</span> <span class="o">=</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span><span class="o">.</span><span class="n">lim_to</span><span class="p">([</span><span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">spath</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">],</span> <span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span>
                            <span class="c1"># Skip empty clusters</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ics</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">c_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                            <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">ics</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_</span><span class="si">%s%s</span><span class="s2">_L</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="n">tn_name</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># TODO: This does not work any more in that way. Rewrite it or remove it</span>
                                <span class="n">radii</span> <span class="o">=</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">radii</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ics</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span>
                                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_radii_</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="n">tn_name</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># coords for current cluster</span>
                        <span class="n">ics</span> <span class="o">=</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">c_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">ics</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="n">tn_name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># TODO: This does not work any more in that way. Rewrite it or remove it</span>
                            <span class="n">radii</span> <span class="o">=</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">radii</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ics</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_radii_</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c_name</span><span class="p">,</span> <span class="n">tn_name</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cluster_area</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">aquaduct.geom</span> <span class="k">import</span> <span class="n">hdr</span>
        <span class="kn">from</span> <span class="nn">aquaduct.geom.hdr_contour</span> <span class="k">import</span> <span class="n">hdr2contour</span><span class="p">,</span> <span class="n">iscontour</span>
        <span class="k">if</span> <span class="n">iscontour</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmaps</span><span class="o">.</span><span class="n">_cmap_jet_256</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Clusters contours&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inls</span><span class="o">.</span><span class="n">clusters_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                            <span class="c1"># coords for current cluster</span>
                            <span class="n">ics</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim_to</span><span class="p">([</span><span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">spath</span> <span class="ow">in</span> <span class="n">spaths</span><span class="p">],</span> <span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">c_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                            <span class="c1"># calcualte hdr</span>
                            <span class="c1"># print inls.center_of_system, c_name, len(ics), alt_center_of_system</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ics</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">HDR</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ics</span><span class="p">),</span> <span class="n">points</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_precision</span><span class="p">),</span>
                                        <span class="n">expand_by</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_expand</span><span class="p">),</span>
                                        <span class="n">center_of_system</span><span class="o">=</span><span class="n">inls</span><span class="o">.</span><span class="n">center_of_system</span><span class="p">)</span>
                            <span class="n">spp</span><span class="o">.</span><span class="n">multiline_begin</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># range(100, 85, -5) + range(80, 40, -10):</span>
                                <span class="c1"># print c_name + &#39;_D%d&#39; % fraction</span>
                                <span class="n">coords</span> <span class="o">=</span> <span class="n">hdr2contour</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fraction</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">))]</span>
                                    <span class="n">spp</span><span class="o">.</span><span class="n">multiline_add</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                            <span class="n">spp</span><span class="o">.</span><span class="n">multiline_end</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c_name</span> <span class="o">+</span> <span class="s1">&#39;_L</span><span class="si">{}</span><span class="s1">_DC&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># coords for current cluster</span>
                        <span class="n">ics</span> <span class="o">=</span> <span class="n">inls</span><span class="o">.</span><span class="n">lim2clusters</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">c_name</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">c_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                        <span class="c1"># calcualte hdr</span>
                        <span class="c1"># print inls.center_of_system, c_name, len(ics), alt_center_of_system</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ics</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">h</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">HDR</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ics</span><span class="p">),</span> <span class="n">points</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_precision</span><span class="p">),</span>
                                    <span class="n">expand_by</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_area_expand</span><span class="p">),</span>
                                    <span class="n">center_of_system</span><span class="o">=</span><span class="n">inls</span><span class="o">.</span><span class="n">center_of_system</span><span class="p">)</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">multiline_begin</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># range(100, 85, -5) + range(80, 40, -10):</span>
                            <span class="c1"># print c_name + &#39;_D%d&#39; % fraction</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="n">hdr2contour</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fraction</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">))]</span>
                                <span class="n">spp</span><span class="o">.</span><span class="n">multiline_add</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                        <span class="n">spp</span><span class="o">.</span><span class="n">multiline_end</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c_name</span> <span class="o">+</span> <span class="s1">&#39;_DC&#39;</span><span class="p">)</span>
            <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center_of_system</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CoS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">center_of_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spp</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center_of_object</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CoO&quot;</span><span class="p">)</span>

    <span class="n">fof</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">make_fractionof</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">ctypes_amount</span><span class="p">))</span>

    <span class="c1"># master paths can have some keys which are not of ct type - names of molecules</span>
    <span class="c1"># print master_paths.keys()</span>
    <span class="c1"># print master_paths_smooth.keys()</span>
    <span class="n">master_paths_separate</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

    <span class="c1"># TODO: is isinstance good in this instance?</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">ctypes_raw</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;CTypes raw&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">tn_name</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Paths in layer </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                            <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">spath</span><span class="p">:</span> <span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">,</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">))),</span>
                                               <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">),</span>
                                               <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                        <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)),</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw&#39;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mp_nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">master_paths_separate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">mp_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp_nr</span><span class="p">:</span>
                        <span class="n">mp_name</span> <span class="o">=</span> <span class="n">master_paths_separate</span><span class="p">[</span><span class="n">mp_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">mp_name</span><span class="p">]:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">mp_name</span><span class="p">][</span><span class="n">ct</span><span class="p">]</span>
                            <span class="n">mp_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">mp_name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">mp</span><span class="p">],</span>
                                           <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw_master&#39;</span> <span class="o">+</span> <span class="n">mp_name</span><span class="p">,</span>
                                           <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                           <span class="n">smooth</span><span class="o">=</span><span class="k">lambda</span> <span class="n">anything</span><span class="p">:</span> <span class="n">anything</span><span class="p">)</span>

    <span class="n">master_paths_separate</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">ctypes_smooth</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;CTypes smooth&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctypes_generic_list</span><span class="p">):</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">),</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">tn_name</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Paths in layer </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

                            <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                            <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                            <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">spath</span><span class="p">:</span> <span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">,</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">))),</span>
                                               <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_smooth&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">),</span>
                                               <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                               <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sps</span> <span class="o">=</span> <span class="n">lind</span><span class="p">(</span><span class="n">spaths</span><span class="p">,</span> <span class="n">what2what</span><span class="p">(</span><span class="n">ctypes_generic</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">]))</span>
                        <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span> <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)),</span> <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_smooth&#39;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                           <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mp_nr</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">master_paths_separate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">mp_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp_nr</span><span class="p">:</span>
                        <span class="n">mp_name</span> <span class="o">=</span> <span class="n">master_paths_separate</span><span class="p">[</span><span class="n">mp_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">mp_name</span><span class="p">]:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">mp_name</span><span class="p">][</span><span class="n">ct</span><span class="p">]</span>
                            <span class="n">mp_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">mp_name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">mp</span><span class="p">],</span>
                                           <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_smooth_master&#39;</span> <span class="o">+</span> <span class="n">mp_name</span><span class="p">,</span>
                                           <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                           <span class="n">smooth</span><span class="o">=</span><span class="k">lambda</span> <span class="n">anything</span><span class="p">:</span> <span class="n">anything</span><span class="p">)</span>
                    <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp_nr</span><span class="p">:</span>
                        <span class="n">mp_name</span> <span class="o">=</span> <span class="n">master_paths_separate</span><span class="p">[</span><span class="n">mp_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">mp_name</span><span class="p">]:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths</span><span class="p">[</span><span class="n">mp_name</span><span class="p">][</span><span class="n">ct</span><span class="p">]</span>
                            <span class="n">mp_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">mp_name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">master_paths_smooth</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="n">master_paths_smooth</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plot_spaths_traces</span><span class="p">([</span><span class="n">mp</span><span class="p">],</span>
                                           <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_raw_master_smooth&#39;</span> <span class="o">+</span> <span class="n">mp_name</span><span class="p">,</span>
                                           <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                           <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">tn_name</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_raw</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All raw paths&quot;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_raw&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">split</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">all_paths_split</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_raw_io</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All raw paths io&quot;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
                <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_raw_paths_io&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_smooth</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All smooth paths&quot;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_smooth&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">split</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">all_paths_split</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">,</span>
                                   <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">all_paths_smooth_io</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;All smooth paths io&quot;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
                <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">fof</span><span class="p">(</span><span class="n">paths</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all_smooth_paths_io&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Paths as states&quot;</span> <span class="o">+</span> <span class="n">tn_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_raw</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;raw_paths&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                                   <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                                   <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_smooth</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plot_spaths_traces</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth_paths&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                                   <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_raw_io</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;raw_io&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;raw_paths_io&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                                   <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_smooth_io</span><span class="p">:</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;smooth_io&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plot_spaths_inlets</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;smooth_paths_io&#39;</span> <span class="o">+</span> <span class="n">tn_name</span> <span class="o">+</span> <span class="n">layer_name</span><span class="p">,</span>
                                   <span class="n">states</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span>
                                   <span class="n">separate</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">paths_states</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="n">spp</span><span class="p">)</span>

    <span class="n">fof</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">make_fractionof</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">all_paths_amount</span><span class="p">))</span>
    <span class="n">tn_lim</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tn</span><span class="p">:</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">tn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">sp</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">spaths</span> <span class="k">if</span> <span class="n">tn</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">tn_name</span> <span class="ow">in</span> <span class="n">iter_over_tn</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">Reader</span><span class="o">.</span><span class="n">sandwich_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()):</span>
                <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Paths in layer </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">Reader</span><span class="o">.</span><span class="n">number_of_layers</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">plot_paths</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">spath</span><span class="p">:</span> <span class="n">spath</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">,</span> <span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">)),</span> <span class="n">tn_name</span><span class="p">,</span> <span class="s2">&quot;_L</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_paths</span><span class="p">(</span><span class="n">tn_lim</span><span class="p">(</span><span class="n">tn</span><span class="p">),</span> <span class="n">tn_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">show_molecule</span><span class="p">:</span>
        <span class="n">pymol_connector</span><span class="o">.</span><span class="n">orient_on</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_pymol_connector_session</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">clui</span><span class="o">.</span><span class="n">fbm</span><span class="p">(</span><span class="s2">&quot;Saving session (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">):</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># new line</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">clui</span><span class="o">.</span><span class="n">pbar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">))</span>
            <span class="c1"># FIXME: Loop over states is not required if there is no object with many states.</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spaths</span><span class="p">)):</span>
                <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="n">state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">clui</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Finalizing session saving...&quot;</span><span class="p">,</span> <span class="n">cont</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># new line</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">set_frame</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pymol_connector</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span></div>


<span class="c1">################################################################################</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;valve_exec_stage</span>
<span class="s1">stage_I_run</span>
<span class="s1">stage_II_run</span>
<span class="s1">stage_III_run</span>
<span class="s1">stage_IV_run</span>
<span class="s1">stage_V_run</span>
<span class="s1">stage_VI_run</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">Aqua-Duct 1.0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../aquaduct.html" >aquaduct</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../valve.html" >aquaduct.apps.valve</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, 2017, 2018 Tomasz Magdziarz, Karolina Mitusińska, Agata Raczyńska, Artur Góra.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>